{% extends 'base.html.twig' %}

{% block title %}Gestión de Planes - SpartaMGym{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .page-header {
            background: linear-gradient(135deg, #0f172a 0%, #dc2626 100%);
            color: white;
            padding: 2.2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 26px 26px;
            box-shadow: 0 28px 48px -36px rgba(15, 23, 42, 0.9);
        }
        .table-container {
            background: rgba(255, 255, 255, 0.92);
            padding: 1.15rem;
            border-radius: 18px;
            border: 1px solid #dbe6f4;
            box-shadow: 0 20px 34px -30px rgba(15, 23, 42, 0.65);
        }
        .table-container .table {
            font-size: 0.84rem;
        }
        .table-container .table > :not(caption) > * > * {
            padding: 0.44rem 0.48rem;
            white-space: nowrap;
        }
        .table-container .table td:nth-child(2),
        .table-container .table th:nth-child(2) {
            min-width: 150px;
        }
        .btn-rounded {
            border-radius: 10px;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="page-header shadow-sm">
        <div class="container-fluid px-3 px-lg-4 d-flex justify-content-between align-items-center gap-2 flex-wrap">
            <div>
                <h2 class="fw-bold mb-0">Catálogo de Planes</h2>
                <p class="mb-0 opacity-75">Configura las membresías y beneficios de tu gimnasio</p>
            </div>
            <div class="d-flex gap-2">
                <button type="button" id="btn-nuevo-plan" class="btn btn-light btn-rounded shadow-sm fw-bold">
                    <i class="bi bi-plus-circle me-1"></i>Nuevo Plan
                </button>
            </div>
        </div>
    </div>

    <div class="container-fluid px-3 px-lg-4 pb-5">
        <div class="table-container shadow-sm">
            <h5 class="fw-bold mb-3">
                <i class="bi bi-list-check me-2 text-dark"></i>Planes Registrados
            </h5>

            <table id="table_planes"
                   class="table"
                   data-url="{{ path('app_panel_planes_listar') }}"
                   data-toggle="table"
                   data-search="true"
                   data-pagination="true"
                   data-page-size="12"
                   data-classes="table table-sm table-hover align-middle"
                   data-header-style="headerStyle">
                <thead>
                    <tr>
                        <th data-field="id" data-sortable="true" data-width="60">ID</th>
                        <th data-field="nombre" data-sortable="true">Nombre</th>
                        <th data-field="precio" data-sortable="true" data-formatter="priceFormatter" data-align="right">Precio</th>
                        <th data-field="tiempo" data-width="90" data-align="center">Días</th>
                        <th data-field="max_beneficiarios" data-width="120" data-align="center">Benef.</th>
                        <th data-field="detalle" data-formatter="beneficiosButtonFormatter" data-events="operateEvents" data-align="center" data-width="130">Beneficios</th>
                        <th data-field="operate" data-align="center" data-width="110" data-formatter="accionesFormatter" data-events="operateEvents">Acciones</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>

    <div class="modal fade" id="modal-plan" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-dark text-white p-4">
                    <h5 class="modal-title fw-bold" id="form-title">
                        <i class="bi bi-plus-circle me-2"></i>Registrar Nuevo Plan
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-plan" class="modal-body p-4">
                    <input type="hidden" id="id" name="id" value="0">

                    <div class="mb-3">
                        <label for="nombre" class="form-label fw-semibold small">Nombre del Plan</label>
                        <input type="text" class="form-control" id="nombre" name="nombre" required placeholder="Ej: Membresía VIP">
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="precio" class="form-label fw-semibold small">Precio ($)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light text-muted border-end-0">$</span>
                                <input type="number" class="form-control border-start-0" id="precio" name="precio" min="0" step="1" required placeholder="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="tiempo" class="form-label fw-semibold small">Duración (Días)</label>
                            <input type="number" class="form-control" id="tiempo" name="tiempo" required placeholder="30">
                        </div>
                    </div>

                    <div class="mt-3">
                        <label for="max_beneficiarios" class="form-label fw-semibold small">Beneficiarios por venta</label>
                        <input type="number" class="form-control" id="max_beneficiarios" name="max_beneficiarios" min="1" step="1" value="1" required>
                        <div class="form-text small"><code>1</code> = plan individual, <code>2</code> o más = plan compartido.</div>
                    </div>

                    <div class="mt-3">
                        <label for="detalle" class="form-label fw-semibold small">Beneficios (Separados por coma)</label>
                        <textarea class="form-control" id="detalle" name="detalle" rows="4" placeholder="Acceso 24/7, Sauna, Entrenador..."></textarea>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button type="button" class="btn btn-light btn-rounded px-4" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger btn-rounded px-4 fw-bold" id="btn-submit">
                            <i class="bi bi-save me-1"></i>Guardar Plan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-beneficios-plan" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-dark text-white p-4">
                    <h5 class="modal-title fw-bold" id="beneficiosPlanTitle">
                        <i class="bi bi-stars me-2"></i>Beneficios del Plan
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <ul class="list-group list-group-flush" id="beneficiosPlanList"></ul>
                </div>
            </div>
        </div>
    </div>

<script>
    function headerStyle() {
        return { classes: 'bg-light fw-bold text-muted small text-uppercase' };
    }

    function priceFormatter(value) {
        return '<span class="fw-bold text-dark">$' + Number(value || 0).toLocaleString() + '</span>';
    }

    function parseBeneficios(raw) {
        if (!raw) return [];
        return String(raw)
            .split(',')
            .map(item => item.trim())
            .filter(Boolean);
    }

    function beneficiosButtonFormatter(value) {
        const total = parseBeneficios(value).length;
        if (total === 0) {
            return '<span class="badge bg-light text-muted border">Sin beneficios</span>';
        }
        return `<button class="btn btn-outline-secondary btn-sm rounded-pill ver_beneficios"><i class="bi bi-list-stars me-1"></i>${total}</button>`;
    }

    function accionesFormatter() {
        return `
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary editar" title="Editar"><i class="bi bi-pencil-fill"></i></button>
                <button class="btn btn-outline-danger eliminar" title="Eliminar"><i class="bi bi-trash-fill"></i></button>
            </div>`;
    }

    const modalPlanEl = document.getElementById('modal-plan');
    const modalBeneficiosEl = document.getElementById('modal-beneficios-plan');
    let modalPlan = null;
    let modalBeneficios = null;
    function getModalPlan() {
        if (!modalPlan) {
            modalPlan = bootstrap.Modal.getOrCreateInstance(modalPlanEl);
        }
        return modalPlan;
    }
    function getModalBeneficios() {
        if (!modalBeneficios) {
            modalBeneficios = bootstrap.Modal.getOrCreateInstance(modalBeneficiosEl);
        }
        return modalBeneficios;
    }

    function openBeneficiosModal(row) {
        const title = document.getElementById('beneficiosPlanTitle');
        const list = document.getElementById('beneficiosPlanList');
        const beneficios = parseBeneficios(row?.detalle);
        title.innerHTML = `<i class="bi bi-stars me-2"></i>Beneficios: ${row?.nombre || 'Plan'}`;
        list.innerHTML = '';

        if (beneficios.length === 0) {
            const emptyItem = document.createElement('li');
            emptyItem.className = 'list-group-item text-muted';
            emptyItem.textContent = 'Este plan no tiene beneficios configurados.';
            list.appendChild(emptyItem);
        } else {
            beneficios.forEach((beneficio) => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex align-items-center gap-2';
                li.innerHTML = '<i class="bi bi-check2-circle text-success"></i>';
                li.appendChild(document.createTextNode(beneficio));
                list.appendChild(li);
            });
        }

        getModalBeneficios().show();
    }

    function resetForm() {
        document.getElementById('form-plan').reset();
        document.getElementById('id').value = 0;
        document.getElementById('max_beneficiarios').value = 1;
        document.getElementById('form-title').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Registrar Nuevo Plan';
        document.getElementById('btn-submit').className = 'btn btn-danger btn-rounded px-4 fw-bold';
        document.getElementById('btn-submit').innerHTML = '<i class="bi bi-save me-1"></i>Guardar Plan';
    }

    document.getElementById('btn-nuevo-plan').addEventListener('click', function () {
        resetForm();
        getModalPlan().show();
    });

    window.operateEvents = {
        'click .ver_beneficios': function (e, value, row) {
            openBeneficiosModal(row);
        },
        'click .editar': function (e, value, row) {
            resetForm();
            document.getElementById('id').value = row.id;
            document.getElementById('nombre').value = row.nombre || '';
            document.getElementById('precio').value = row.precio || 0;
            document.getElementById('tiempo').value = row.tiempo || 0;
            document.getElementById('detalle').value = row.detalle || '';
            document.getElementById('max_beneficiarios').value = row.max_beneficiarios || 1;
            document.getElementById('form-title').innerHTML = '<i class="bi bi-pencil-square me-2"></i>Editando Plan #' + row.id;
            document.getElementById('btn-submit').className = 'btn btn-primary btn-rounded px-4 fw-bold';
            document.getElementById('btn-submit').innerHTML = '<i class="bi bi-save me-1"></i>Actualizar';
            getModalPlan().show();
        },
        'click .eliminar': async function (e, value, row) {
            const result = await Swal.fire({
                title: '¿Eliminar plan?',
                text: `Se eliminará el plan "${row.nombre}".`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            });

            if (!result.isConfirmed) return;

            const formData = new FormData();
            formData.append('id', row.id);

            const response = await fetch('{{ path('app_panel_planes_eliminar') }}', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (!response.ok || data.status !== 'success') {
                Swal.fire('Error', data.message || 'No se pudo eliminar el plan.', 'error');
                return;
            }

            $('#table_planes').bootstrapTable('refresh');
            Swal.fire({ icon: 'success', title: 'Eliminado', text: data.message, timer: 1800, showConfirmButton: false });
        }
    };

    document.getElementById('form-plan').addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(this);

        try {
            const response = await fetch('{{ path('app_panel_planes_crear') }}', { method: 'POST', body: formData });
            const data = await response.json();

            if (!response.ok || data.status !== 'success') {
                Swal.fire('Error', data.message || 'No se pudo guardar el plan.', 'error');
                return;
            }

            const instance = bootstrap.Modal.getInstance(modalPlanEl);
            if (instance) instance.hide();
            resetForm();
            $('#table_planes').bootstrapTable('refresh');
            Swal.fire({ icon: 'success', title: 'Guardado', text: data.message, timer: 1800, showConfirmButton: false });
        } catch (error) {
            console.error('Error:', error);
            Swal.fire('Error', 'No se pudo conectar con el servidor', 'error');
        }
    });

    modalPlanEl.addEventListener('hidden.bs.modal', resetForm);
</script>
{% endblock %}
