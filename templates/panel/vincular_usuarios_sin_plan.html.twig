{% extends 'base.html.twig' %}

{% block title %}Inscripción a Planes - SpartaMGym{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .page-header {
            background: linear-gradient(135deg, #0f172a 0%, #1d4ed8 100%);
            color: white;
            padding: 2.2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 26px 26px;
            box-shadow: 0 28px 48px -36px rgba(15, 23, 42, 0.9);
        }
        .card-custom {
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid #dbe6f4;
            box-shadow: 0 20px 34px -30px rgba(15, 23, 42, 0.65);
            height: 100%;
        }
        .table-title {
            font-weight: 700;
            color: #1e293b;
            padding: 1rem 0;
            border-bottom: 2px solid #f1f5f9;
            margin-bottom: 1rem;
        }
        .btn-action {
            border-radius: 999px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        .selection-panel {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 18px;
            padding: 1.5rem;
            position: sticky;
            top: 100px;
            border: 1px solid #dbe6f4;
        }
        .card-custom .table {
            font-size: 0.83rem;
        }
        .card-custom .table > :not(caption) > * > * {
            padding: 0.42rem 0.46rem;
            white-space: nowrap;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="page-header shadow-sm">
        <div class="container-fluid px-3 px-lg-4 d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold mb-0">Inscripción de Socios</h2>
                <p class="mb-0 opacity-75">Asigna membresías activas a los socios registrados</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <div class="d-flex align-items-center bg-white rounded px-2 py-1 shadow-sm">
                    <label for="fecha-inicio-plan" class="small text-muted me-2 mb-0">Inicio</label>
                    <input id="fecha-inicio-plan" type="date" class="form-control form-control-sm border-0 p-0" value="{{ 'now'|date('Y-m-d') }}">
                </div>
                <button id="btn-unir" class="btn btn-success btn-action shadow-sm">
                    <i class="bi bi-link-45deg me-2"></i>Confirmar Inscripción
                </button>
            </div>
        </div>
    </div>

    <div class="container-fluid px-3 px-lg-4 pb-5">
        <div class="row g-4">
            <!-- Columna Planes -->
            <div class="col-lg-6">
                <div class="card-custom p-4">
                    <h5 class="table-title">
                        <i class="bi bi-tags-fill me-2 text-primary"></i>1. Seleccione un Plan
                    </h5>
                    <table id="table_planes"
                           class="table"
                           data-url="{{ path('app_panel_planes_listar') }}"
                           data-toggle="table"
                           data-search="true"
                           data-pagination="true"
                           data-page-size="5"
                           data-click-to-select="true"
                           data-single-select="true"
                           data-classes="table table-sm table-hover align-middle"
                           data-header-style="headerStyle">
                        <thead>
                            <tr>
                                <th data-field="state" data-checkbox="true"></th>
                                <th data-field="nombre" data-sortable="true">Nombre</th>
                                <th data-field="precio" data-formatter="priceFormatter">Precio</th>
                                <th data-field="tiempo" data-align="center">Días</th>
                                <th data-field="max_beneficiarios" data-align="center">Benef.</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>

            <!-- Columna Usuarios -->
            <div class="col-lg-6">
                <div class="card-custom p-4">
                    <h5 class="table-title">
                        <i class="bi bi-person-check-fill me-2 text-success"></i>2. Seleccione uno o más socios
                    </h5>
                    <div class="small text-muted mb-2">
                        <i class="bi bi-check-circle-fill text-success me-1"></i>Vigente
                        <span class="mx-2"></span>
                        <i class="bi bi-x-circle-fill text-danger me-1"></i>Vencido
                        <span class="mx-2"></span>
                        <i class="bi bi-exclamation-circle-fill text-warning me-1"></i>Sin plan
                    </div>
                    <div id="shared-plan-info" class="alert alert-light border small py-2 px-3 mb-3">
                        Seleccione un plan para ver el máximo de beneficiarios permitidos.
                    </div>
                    <table id="table_usuarios"
                           class="table"
                           data-url="{{ path('app_panel_usuarios_sin_plan') }}"
                           data-toggle="table"
                           data-search="true"
                           data-pagination="true"
                           data-page-size="5"
                           data-click-to-select="true"
                           data-single-select="false"
                           data-classes="table table-sm table-hover align-middle"
                           data-header-style="headerStyle">
                        <thead>
                            <tr>
                                <th data-field="state" data-checkbox="true" data-formatter="userStateCheckboxFormatter"></th>
                                <th data-field="nombre" data-sortable="true">Nombre</th>
                                <th data-field="cedula" data-sortable="true">Cédula</th>
                                <th data-field="plan_status" data-formatter="planStatusFormatter" data-align="center">Estado</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    function headerStyle() {
        return { classes: 'bg-light fw-bold text-muted small text-uppercase' };
    }

    function priceFormatter(value) {
        return '<span class="fw-bold">$' + parseInt(value).toLocaleString() + '</span>';
    }

    function planStatusFormatter(value, row) {
        if (value === 'vigente') {
            return '<span class="text-success fw-semibold"><i class="bi bi-check-circle-fill me-1"></i>Vigente</span>';
        }
        if (value === 'vencido') {
            return '<span class="text-danger fw-semibold"><i class="bi bi-x-circle-fill me-1"></i>Vencido</span>';
        }
        if (value === 'programado') {
            return '<span class="text-warning fw-semibold"><i class="bi bi-clock-history me-1"></i>Programado</span>';
        }
        return '<span class="text-warning fw-semibold"><i class="bi bi-exclamation-circle-fill me-1"></i>Sin plan</span>';
    }

    function userStateCheckboxFormatter(value, row) {
        return {
            disabled: !!row.plan_blocked
        };
    }

    function getSelectedUsers() {
        const users = $('#table_usuarios').bootstrapTable('getSelections');
        return Array.isArray(users) ? users : [];
    }

    function updateSharedPlanInfo() {
        const selectedPlan = $('#table_planes').bootstrapTable('getSelections')[0];
        const selectedUsers = getSelectedUsers();
        const info = document.getElementById('shared-plan-info');
        if (!info) {
            return;
        }

        if (!selectedPlan) {
            info.className = 'alert alert-light border small py-2 px-3 mb-3';
            info.textContent = 'Seleccione un plan para ver el máximo de beneficiarios permitidos.';
            return;
        }

        const maxBeneficiarios = parseInt(selectedPlan.max_beneficiarios || 1, 10);
        const esValido = selectedUsers.length <= maxBeneficiarios;
        info.className = 'alert ' + (esValido ? 'alert-success' : 'alert-danger') + ' border small py-2 px-3 mb-3';
        info.textContent = `Plan "${selectedPlan.nombre}": ${selectedUsers.length} seleccionado(s) de máximo ${maxBeneficiarios} beneficiario(s).`;
    }

    $('#table_planes').on('check.bs.table uncheck.bs.table check-all.bs.table uncheck-all.bs.table load-success.bs.table', updateSharedPlanInfo);
    $('#table_usuarios').on('check.bs.table uncheck.bs.table check-all.bs.table uncheck-all.bs.table load-success.bs.table', updateSharedPlanInfo);
    document.addEventListener('DOMContentLoaded', updateSharedPlanInfo);

    document.getElementById('btn-unir').addEventListener('click', function() {
        const selectedUsers = getSelectedUsers();
        const selectedPlan = $('#table_planes').bootstrapTable('getSelections')[0];
    
        if (!selectedPlan || selectedUsers.length === 0) {
            Swal.fire({ 
                title: 'Selección Incompleta', 
                text: 'Debe elegir un plan y al menos un socio de las tablas anteriores.', 
                icon: 'info', 
                confirmButtonColor: '#3b82f6' 
            });
            return;
        }

        const maxBeneficiarios = parseInt(selectedPlan.max_beneficiarios || 1, 10);
        if (selectedUsers.length > maxBeneficiarios) {
            Swal.fire({
                title: 'Cupo excedido',
                text: `Este plan admite máximo ${maxBeneficiarios} beneficiario(s) por asignación.`,
                icon: 'warning',
                confirmButtonColor: '#dc3545'
            });
            return;
        }

        const nombres = selectedUsers.map((user) => user.nombre).join(', ');

        Swal.fire({
            title: '¿Confirmar Inscripción?',
            text: `Se asignará el plan "${selectedPlan.nombre}" a ${selectedUsers.length} socio(s): ${nombres}`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#198754',
            confirmButtonText: 'Sí, inscribir ahora'
        }).then((result) => {
            if (result.isConfirmed) {
                const formData = new FormData();
                formData.append('id_plan', selectedPlan.id);
                formData.append('fecha_inicio', document.getElementById('fecha-inicio-plan').value);
                selectedUsers.forEach((user) => {
                    formData.append('id_usuarios[]', user.id);
                });

                fetch('{{ path('app_panel_vincular_usuario_plan') }}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        Swal.fire({
                            icon: 'success',
                            title: '¡Inscrito!',
                            text: data.message,
                            timer: 2500
                        });
                        $('#table_usuarios').bootstrapTable('refresh');
                        $('#table_usuarios').bootstrapTable('uncheckAll');
                        $('#table_planes').bootstrapTable('uncheckAll');
                        updateSharedPlanInfo();
                    } else {
                        Swal.fire('Error', data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error', 'No se pudo procesar la solicitud', 'error');
                });
            }
        });
    }); 
</script>
{% endblock %}
