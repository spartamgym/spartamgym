{% extends 'base.html.twig' %}

{% block title %}Asignación de Acceso - SpartaMGym{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .page-header {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
        }
        .card-custom {
            border: none;
            border-radius: 15px;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            height: 100%;
        }
        .table-title {
            font-weight: 700;
            color: #1e293b;
            padding: 1rem 0;
            border-bottom: 2px solid #f1f5f9;
            margin-bottom: 1rem;
        }
        .btn-action {
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="page-header shadow-sm">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold mb-0">Asignación de Tarjetas</h2>
                <p class="mb-0 opacity-75">Vincula identificadores físicos a los perfiles de los socios</p>
            </div>
            <div class="d-flex gap-2">
                <button id="btn-unir" class="btn btn-success btn-action shadow-sm">
                    <i class="bi bi-link me-2"></i>Vincular Ahora
                </button>
                <a href="{{ path('app_panel') }}" class="btn btn-light btn-action shadow-sm">
                    <i class="bi bi-house me-2"></i>Inicio
                </a>
            </div>
        </div>
    </div>

    <div class="container pb-5">
        <div class="row g-4">
            <!-- Columna Tarjetas -->
            <div class="col-lg-6">
                <div class="card-custom p-4">
                    <h5 class="table-title">
                        <i class="bi bi-credit-card-2-front-fill me-2 text-primary"></i>1. Tarjetas Disponibles
                    </h5>
                    <table id="table_cards"
                           class="table"
                           data-url="{{ path('app_panel_listar_targetas_disponibles') }}"
                           data-toggle="table"
                           data-search="true"
                           data-pagination="true"
                           data-page-size="5"
                           data-click-to-select="true"
                           data-single-select="true"
                           data-classes="table table-hover"
                           data-header-style="headerStyle">
                        <thead>
                            <tr>
                                <th data-field="state" data-checkbox="true"></th>
                                <th data-field="id" data-sortable="true" data-width="50">ID</th>
                                <th data-field="code" data-sortable="true">Código RFID/NFC</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>

            <!-- Columna Usuarios -->
            <div class="col-lg-6">
                <div class="card-custom p-4">
                    <h5 class="table-title">
                        <i class="bi bi-person-bounding-box me-2 text-success"></i>2. Seleccione Socio
                    </h5>
                    <table id="table_usuarios"
                           class="table"
                           data-url="{{ path('app_panel_listar_usuarios_disponibles') }}"
                           data-toggle="table"
                           data-search="true"
                           data-pagination="true"
                           data-page-size="5"
                           data-click-to-select="true"
                           data-single-select="true"
                           data-classes="table table-hover"
                           data-header-style="headerStyle">
                        <thead>
                            <tr>
                                <th data-field="state" data-checkbox="true"></th>
                                <th data-field="nombre" data-sortable="true">Nombre</th>
                                <th data-field="cedula" data-sortable="true">Cédula</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    function headerStyle() {
        return { classes: 'bg-light fw-bold text-muted small text-uppercase' };
    }

    document.getElementById('btn-unir').addEventListener('click', function() {
        const selectedCard = $('#table_cards').bootstrapTable('getSelections')[0];
        const selectedUsuario = $('#table_usuarios').bootstrapTable('getSelections')[0];

        if (!selectedCard || !selectedUsuario) {
            Swal.fire({ 
                title: 'Atención', 
                text: 'Debe seleccionar una tarjeta y un usuario para continuar.', 
                icon: 'warning',
                confirmButtonColor: '#0d6efd'
            });
            return;
        }

        Swal.fire({
            title: '¿Confirmar Vinculación?',
            text: `Se asignará la tarjeta ${selectedCard.code} al socio ${selectedUsuario.nombre}`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#198754',
            confirmButtonText: 'Sí, vincular'
        }).then((result) => {
            if (result.isConfirmed) {
                const formData = new FormData();
                formData.append('id_card', selectedCard.id);
                formData.append('id_usuario', selectedUsuario.id);

                fetch('{{ path('app_panel_vincular_targeta_procesar') }}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {         
                        Swal.fire({
                            icon: 'success',
                            title: 'Vinculación Exitosa',
                            text: data.message,
                            timer: 2000
                        });
                        $('#table_cards').bootstrapTable('refresh');
                        $('#table_usuarios').bootstrapTable('refresh');
                    } else {
                        Swal.fire('Error', data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error', 'No se pudo completar la operación', 'error');
                });
            }
        });
    });
</script>
{% endblock %}
