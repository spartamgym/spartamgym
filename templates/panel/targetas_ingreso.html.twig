{% extends 'base.html.twig' %}

{% block title %}Inventario de Tarjetas - SpartaMGym{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .page-header {
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            color: white;
            padding: 2.2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 26px 26px;
            box-shadow: 0 28px 48px -36px rgba(15, 23, 42, 0.9);
        }
        .table-container {
            background: rgba(255, 255, 255, 0.92);
            padding: 1.15rem;
            border-radius: 18px;
            border: 1px solid #dbe6f4;
            box-shadow: 0 20px 34px -30px rgba(15, 23, 42, 0.65);
        }
        .table-container .table {
            font-size: 0.84rem;
        }
        .table-container .table > :not(caption) > * > * {
            padding: 0.44rem 0.48rem;
            white-space: nowrap;
        }
        .btn-rounded {
            border-radius: 10px;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="page-header shadow-sm">
        <div class="container-fluid px-3 px-lg-4 d-flex justify-content-between align-items-center gap-2 flex-wrap">
            <div>
                <h2 class="fw-bold mb-0">Tarjetas de Acceso</h2>
                <p class="mb-0 opacity-75">Control de inventario y estado de dispositivos RFID/NFC</p>
            </div>
            <div class="d-flex gap-2">
                <button type="button" id="btn-nueva-targeta" class="btn btn-light btn-rounded shadow-sm fw-bold">
                    <i class="bi bi-plus-circle me-1"></i>Nueva Tarjeta
                </button>
            </div>
        </div>
    </div>

    <div class="container-fluid px-3 px-lg-4 pb-5">
        <div class="table-container shadow-sm">
            <h5 class="fw-bold mb-3">
                <i class="bi bi-inventory me-2 text-dark"></i>Inventario de Dispositivos
            </h5>

            <table id="table_targetas"
                   class="table"
                   data-url="{{ path('app_panel_listar_targetas') }}"
                   data-toggle="table"
                   data-search="true"
                   data-pagination="true"
                   data-page-size="12"
                   data-classes="table table-sm table-hover align-middle"
                   data-header-style="headerStyle">
                <thead>
                    <tr>
                        <th data-field="id" data-sortable="true" data-width="60">ID</th>
                        <th data-field="code" data-sortable="true">Código</th>
                        <th data-field="usuario" data-sortable="true" data-formatter="userFormatter">Asignado a</th>
                        <th data-field="status" data-align="center" data-formatter="statusFormatter">Estado</th>
                        <th data-field="operate" data-align="center" data-width="110" data-formatter="accionesFormatter" data-events="operateEvents">Acciones</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>

    <div class="modal fade" id="modal-targeta" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-dark text-white p-4">
                    <h5 class="modal-title fw-bold" id="form-title">
                        <i class="bi bi-plus-circle me-2"></i>Registrar Tarjeta
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-targeta" class="modal-body p-4">
                    <input type="hidden" id="id" name="id" value="0">

                    <div class="mb-3">
                        <label for="code" class="form-label fw-semibold small">Código de Identificación</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light text-muted border-end-0"><i class="bi bi-upc-scan"></i></span>
                            <input type="text" class="form-control border-start-0" id="code" name="code" required maxlength="255" placeholder="Escanear o ingresar código">
                        </div>
                        <div class="form-text mt-2 small">Este código debe ser único para cada dispositivo físico.</div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button type="button" class="btn btn-light btn-rounded px-4" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary btn-rounded px-4 fw-bold" id="btn-submit">
                            <i class="bi bi-save me-1"></i>Guardar Tarjeta
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
    function headerStyle() {
        return { classes: 'bg-light fw-bold text-muted small text-uppercase' };
    }

    function userFormatter(value) {
        if (value === 'sin asignar') return '<span class="text-muted small">Disponible</span>';
        return `<span class="fw-bold"><i class="bi bi-person me-1"></i>${value}</span>`;
    }

    function statusFormatter(value) {
        const cls = value === 'activo' ? 'bg-success' : 'bg-secondary';
        return `<span class="badge ${cls} rounded-pill px-3">${String(value || '').toUpperCase()}</span>`;
    }

    function accionesFormatter() {
        return `
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary editar" title="Editar"><i class="bi bi-pencil-fill"></i></button>
                <button class="btn btn-outline-danger eliminar" title="Eliminar"><i class="bi bi-trash-fill"></i></button>
            </div>`;
    }

    const modalTargetaEl = document.getElementById('modal-targeta');
    let modalTargeta = null;
    function getModalTargeta() {
        if (!modalTargeta) {
            modalTargeta = bootstrap.Modal.getOrCreateInstance(modalTargetaEl);
        }
        return modalTargeta;
    }

    function resetForm() {
        document.getElementById('form-targeta').reset();
        document.getElementById('id').value = 0;
        document.getElementById('form-title').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Registrar Tarjeta';
        document.getElementById('btn-submit').className = 'btn btn-primary btn-rounded px-4 fw-bold';
        document.getElementById('btn-submit').innerHTML = '<i class="bi bi-save me-1"></i>Guardar Tarjeta';
    }

    document.getElementById('btn-nueva-targeta').addEventListener('click', function () {
        resetForm();
        getModalTargeta().show();
    });

    window.operateEvents = {
        'click .editar': function (e, value, row) {
            resetForm();
            document.getElementById('id').value = row.id;
            document.getElementById('code').value = row.code || '';
            document.getElementById('form-title').innerHTML = '<i class="bi bi-pencil-square me-2"></i>Editando Tarjeta #' + row.id;
            document.getElementById('btn-submit').innerHTML = '<i class="bi bi-save me-1"></i>Actualizar';
            getModalTargeta().show();
        },
        'click .eliminar': async function (e, value, row) {
            const result = await Swal.fire({
                title: '¿Eliminar tarjeta?',
                text: `Se eliminará la tarjeta "${row.code}".`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            });

            if (!result.isConfirmed) return;

            const formData = new FormData();
            formData.append('id', row.id);

            const response = await fetch('{{ path('app_panel_eliminar_targeta') }}', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (!response.ok || data.status !== 'success') {
                Swal.fire('Error', data.message || 'No se pudo eliminar la tarjeta.', 'error');
                return;
            }

            $('#table_targetas').bootstrapTable('refresh');
            Swal.fire({ icon: 'success', title: 'Eliminada', text: data.message, timer: 1800, showConfirmButton: false });
        }
    };

    document.getElementById('form-targeta').addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        try {
            const response = await fetch('{{ path('app_panel_crear_targeta') }}', { method: 'POST', body: formData });
            const data = await response.json();

            if (!response.ok || data.status !== 'success') {
                Swal.fire('Error', data.message || 'No se pudo guardar la tarjeta.', 'error');
                return;
            }

            const instance = bootstrap.Modal.getInstance(modalTargetaEl);
            if (instance) instance.hide();
            resetForm();
            $('#table_targetas').bootstrapTable('refresh');
            Swal.fire({ icon: 'success', title: 'Guardada', text: data.message, timer: 1800, showConfirmButton: false });
        } catch (error) {
            console.error('Error:', error);
            Swal.fire('Error', 'No se pudo conectar con el servidor', 'error');
        }
    });

    modalTargetaEl.addEventListener('hidden.bs.modal', resetForm);
</script>
{% endblock %}
