{% extends 'base.html.twig' %}

{% block title %}Gestión de Usuarios - SpartaMGym{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .page-header {
            background: linear-gradient(135deg, #198754 0%, #146c43 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
        }
        .card {
            border: none;
            border-radius: 15px;
            overflow: hidden;
        }
        .profile-img-container {
            position: relative;
            width: 100%;
            padding-top: 100%;
            background: #f1f5f9;
        }
        .profile-img-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.15);
            border-color: #198754;
        }
        .btn-rounded {
            border-radius: 10px;
        }
        .table-container {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
{% endblock %}

{% block body %}
    <div class="page-header shadow-sm">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold mb-0">Gestión de Usuarios</h2>
                <p class="mb-0 opacity-75">Registro y administración de socios del gimnasio</p>
            </div>
            <a href="{{ path('app_panel') }}" class="btn btn-light btn-rounded shadow-sm">
                <i class="bi bi-house-door me-2"></i>Volver al Inicio
            </a>
        </div>
    </div>

    <div class="container pb-5">
        <div class="row g-4">
            <!-- Sidebar: Foto y Datos Físicos -->
            <div class="col-lg-4">
                <!-- Card Foto -->
                <div class="card shadow-sm mb-4">
                    <div class="profile-img-container">
                        <img id="imagenPerfilPreview" src="{{ asset('img/profile-img.jpeg') }}" alt="Foto de perfil">
                    </div>
                    <div class="card-body">
                        <label for="imagenPerfil" class="form-label fw-bold small text-muted text-uppercase">Foto de Perfil</label>
                        <input class="form-control form-control-sm" type="file" id="imagenPerfil" name="imagenPerfil" accept="image/*">
                    </div>
                </div>

                <!-- Card Medidas -->
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <h5 class="card-title fw-bold mb-4">
                            <i class="bi bi-rulers me-2 text-primary"></i>Medidas Corporales
                        </h5>
                        <form id="form-datos-fisicos">
                            <input type="hidden" id="id_medida" name="id" value="0">
                            <div class="row g-2">
                                <div class="col-6 mb-2">
                                    <label class="form-label small mb-1">Cintura (cm)</label>
                                    <input type="number" class="form-control form-control-sm" name="cintura" id="cintura">
                                </div>
                                <div class="col-6 mb-2">
                                    <label class="form-label small mb-1">Glúteos (cm)</label>
                                    <input type="number" class="form-control form-control-sm" name="gluteos" id="gluteos">
                                </div>
                                <div class="col-6 mb-2">
                                    <label class="form-label small mb-1">Brazo (cm)</label>
                                    <input type="number" class="form-control form-control-sm" name="brazo" id="brazo">
                                </div>
                                <div class="col-6 mb-2">
                                    <label class="form-label small mb-1">Pecho (cm)</label>
                                    <input type="number" class="form-control form-control-sm" name="pecho" id="pecho">
                                </div>
                                <div class="col-6 mb-2">
                                    <label class="form-label small mb-1">Pierna (cm)</label>
                                    <input type="number" class="form-control form-control-sm" name="pierna" id="pierna">
                                </div>
                                <div class="col-6 mb-2">
                                    <label class="form-label small mb-1">Pantorrilla</label>
                                    <input type="number" class="form-control form-control-sm" name="pantorrilla" id="pantorrilla">
                                </div>
                                <div class="col-4 mb-2">
                                    <label class="form-label small mb-1">Peso (kg)</label>
                                    <input type="number" step="0.1" class="form-control form-control-sm" name="peso" id="peso">
                                </div>
                                <div class="col-4 mb-2">
                                    <label class="form-label small mb-1">Altura</label>
                                    <input type="number" step="0.1" class="form-control form-control-sm" name="altura" id="altura">
                                </div>
                                <div class="col-4 mb-2">
                                    <label class="form-label small mb-1">IMC</label>
                                    <input type="number" step="0.1" class="form-control form-control-sm" name="imc" id="imc">
                                </div>
                            </div>
                            <div class="d-grid mt-3">
                                <button type="submit" class="btn btn-outline-primary btn-sm btn-rounded fw-bold">
                                    Actualizar Medidas
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Formulario Principal -->
            <div class="col-lg-8">
                <div class="card shadow-sm h-100">
                    <div class="card-body p-4">
                        <h5 class="card-title fw-bold mb-4">
                            <i class="bi bi-person-plus-fill me-2 text-success"></i>Registro de Usuario
                        </h5>

                        <form id="form-usuario">
                            <input type="hidden" id="id" name="id" value="0">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">Nombre Completo</label>
                                    <input type="text" class="form-control" id="nombre" name="nombre" required placeholder="Nombre del socio">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">Número de Cédula</label>
                                    <input type="text" class="form-control" id="cedula" name="cedula" required placeholder="ID Identificación">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">Celular / WhatsApp</label>
                                    <input type="tel" class="form-control" id="celular" name="celular" placeholder="+57 ...">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">Correo Electrónico</label>
                                    <input type="email" class="form-control" id="correo" name="correo" placeholder="correo@ejemplo.com">
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label small fw-bold">Dirección de Residencia</label>
                                    <input type="text" class="form-control" id="direccion" name="direccion" placeholder="Calle, Carrera, Barrio...">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">Fecha de Nacimiento</label>
                                    <input type="date" class="form-control" id="fecha_nacimiento" name="fecha_nacimiento">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">EPS / Salud</label>
                                    <input type="text" class="form-control" id="eps" name="eps" placeholder="Entidad de salud">
                                </div>
                            </div>

                            <div class="mt-4 d-flex gap-2">
                                <button type="submit" class="btn btn-success px-4 btn-rounded fw-bold">
                                    <i class="bi bi-save me-2"></i>Guardar Usuario
                                </button>
                                <button id="reset-form-user" type="button" class="btn btn-light px-4 btn-rounded text-muted">
                                    Limpiar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Listado de Usuarios -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="table-container shadow-sm">
                    <h5 class="fw-bold mb-4"><i class="bi bi-list-ul me-2"></i>Base de Datos de Socios</h5>
                    <table 
                        id="table_usuarios" 
                        class="table table-hover" 
                        data-toggle="table" 
                        data-search="true" 
                        data-pagination="true" 
                        data-page-size="10" 
                        data-url="{{ path('app_usuario_listar') }}"
                        data-classes="table"
                        data-header-style="headerStyle"
                    >
                        <thead>
                            <tr>
                                <th data-field="id" data-sortable="true" data-width="50">ID</th>
                                <th data-field="nombre" data-sortable="true">Nombre</th>
                                <th data-field="cedula" data-sortable="true">Cédula</th>
                                <th data-field="celular">Celular</th>
                                <th data-field="code" data-formatter="cardFormatter">Acceso</th>
                                <th data-field="img" data-formatter="imgFormatter" data-align="center">Perfil</th>
                                <th data-field="operate" data-formatter="accionesFormatter" data-events="operateEvents" data-align="center">Acciones</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Planes y Medidas -->
    <div class="modal fade" id="planes-usuario" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-dark text-white p-4">
                    <h5 class="modal-title fw-bold" id="planesUsuarioLabel">Detalle del Socio</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-5">
                        <h6 class="text-muted text-uppercase fw-bold small mb-3">Historial de Membresías</h6>
                        <table class="table" id="table_planes" data-toggle="table">
                            <thead>
                                <tr class="bg-light">
                                    <th data-field="nombre">Plan</th>
                                    <th data-field="precio" data-formatter="priceFormatter">Precio</th>
                                    <th data-field="tiempo">Duración</th>
                                    <th data-field="dias_restantes" data-formatter="daysFormatter">Vencimiento</th>
                                    <th data-field="operate" data-formatter="accionesPlanFormatter" data-events="operateEvents" data-align="center">Predeterminado</th>
                                    <th data-field="status_plan" data-formatter="planActivoFormatter" data-align="center">Estado</th>
                                </tr>
                            </thead>
                        </table>
                    </div>

                    <div>
                        <h6 class="text-muted text-uppercase fw-bold small mb-3">Histórico de Seguimiento Físico</h6>
                        <table class="table table-sm" id="table_medidas" data-toggle="table">
                            <thead class="small bg-light">
                                <tr>
                                    <th data-field="createAt">Fecha</th>
                                    <th data-field="peso">Peso</th>
                                    <th data-field="altura">Altura</th>
                                    <th data-field="imc">IMC</th>
                                    <th data-field="cintura">Cint.</th>
                                    <th data-field="gluteos">Glut.</th>
                                    <th data-field="brazo">Brazo</th>
                                    <th data-field="pecho">Pecho</th>
                                    <th data-field="pierna">Pierna</th>
                                    <th data-field="operate" data-formatter="accionesFormatterMedidas" data-events="operateEvents" data-align="center">Acción</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    function headerStyle() {
        return { classes: 'bg-light fw-bold text-muted small text-uppercase' };
    }

    function imgFormatter(value) {
        let src = value ? value : '{{ asset('img/profile-img.jpeg') }}';
        return `<img src="${src}" class="rounded-circle shadow-sm" style="width: 40px; height: 40px; object-fit: cover; border: 2px solid white;">`;
    }

    function cardFormatter(value) {
        if (!value || value === 'sin asignar') return '<span class="badge bg-light text-muted border">Sin Tarjeta</span>';
        return `<span class="badge bg-info text-dark shadow-sm"><i class="bi bi-credit-card-2-front me-1"></i>${value}</span>`;
    }

    function priceFormatter(value) {
        return '<span class="fw-bold">$' + parseInt(value).toLocaleString() + '</span>';
    }

    function daysFormatter(value) {
        let cls = value > 5 ? 'text-success' : 'text-danger fw-bold';
        return `<span class="${cls}">${value} días</span>`;
    }

    function planActivoFormatter(value) {
        if (value === 'vigente') return '<span class="badge bg-success-subtle text-success border border-success px-3">VIGENTE</span>';
        return '<span class="badge bg-danger-subtle text-danger border border-danger px-3">VENCIDO</span>';
    }

    function accionesFormatter() {
        return `
            <div class="btn-group shadow-sm">
                <button class="btn btn-white btn-sm editar border" title="Editar"><i class="bi bi-pencil-fill text-primary"></i></button>
                <button class="btn btn-white btn-sm desvincular border" title="Quitar Tarjeta"><i class="bi bi-link-45deg text-danger"></i></button>
                <button class="btn btn-white btn-sm planes border" title="Detalles"><i class="bi bi-eye-fill text-success"></i></button>
            </div>`;
    }

    function accionesPlanFormatter(value, row) {
        return `<i class="bi ${row.is_predefinido ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted'} h5 predefinir" style="cursor:pointer;"></i>`;
    }

    function accionesFormatterMedidas() {
        return `<button class="btn btn-link btn-sm p-0 editar_medida"><i class="bi bi-pencil-square"></i></button>`;
    }

    // Lógica de formulario y eventos
    document.getElementById('form-usuario').addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        let img = document.getElementById('imagenPerfil').files[0];
        if(img) formData.append('img', img);

        fetch('{{ path('app_usuario_registro') }}', { method: 'POST', body: formData })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({ icon: 'success', title: '¡Guardado!', text: 'Socio registrado/actualizado correctamente', timer: 2000 });
                $('#table_usuarios').bootstrapTable('refresh');
                resetForm();
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        });
    });

    window.operateEvents = {
        'click .editar': (e, value, row) => {
            document.getElementById('id').value = row.id;
            document.getElementById('imagenPerfilPreview').src = row.img ? row.img : '{{ asset('img/profile-img.jpeg') }}';
            document.getElementById('nombre').value = row.nombre;
            document.getElementById('cedula').value = row.cedula;
            document.getElementById('celular').value = row.celular;
            document.getElementById('direccion').value = row.direccion;
            document.getElementById('fecha_nacimiento').value = row.fecha_nacimiento;
            document.getElementById('eps').value = row.eps;
            document.getElementById('correo').value = row.correo;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        },
        'click .desvincular': async (e, value, row) => {
            const result = await Swal.fire({
                title: '¿Desvincular tarjeta?',
                text: "El usuario perderá el acceso físico",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, desvincular'
            });
            if (result.isConfirmed) {
                const formData = new FormData();
                formData.append('id', row.id);
                let data = await enviarDatos("{{ path('app_usuario_desvincular_card') }}", formData);
                if (data.status === 'success') $('#table_usuarios').bootstrapTable('refresh');
            }
        },
        'click .planes': async (e, value, row) => {
            const formData = new FormData();
            formData.append('id', row.id);
            let planes = await enviarDatos("{{ path('app_usuario_planes') }}", formData);
            let medidas = await enviarDatos("{{ path('app_usuario_medidas') }}", formData);
            $('#table_planes').bootstrapTable('load', planes);
            $('#table_medidas').bootstrapTable('load', medidas);
            document.getElementById('planesUsuarioLabel').innerHTML = `<i class="bi bi-person-vcard me-2"></i>Expediente: ${row.nombre}`;
            new bootstrap.Modal(document.getElementById('planes-usuario')).show();
        },
        'click .predefinir': async (e, value, row) => {
            const formData = new FormData();
            formData.append('id', row.id);
            let data = await enviarDatos("{{ path('app_usuario_plane_predefinir') }}", formData);
            $('#table_planes').bootstrapTable('load', data);
        },
        'click .editar_medida': async (e, value, row) => {
            document.getElementById('id_medida').value = row.id;
            document.getElementById('altura').value = row.altura;
            document.getElementById('peso').value = row.peso;
            document.getElementById('cintura').value = row.cintura;
            document.getElementById('gluteos').value = row.gluteos;
            document.getElementById('brazo').value = row.brazo;
            document.getElementById('pecho').value = row.pecho;
            document.getElementById('pierna').value = row.pierna;
            document.getElementById('pantorrilla').value = row.pantorrilla;
            document.getElementById('imc').value = row.imc;
            
            const modalEl = document.getElementById('planes-usuario');
            bootstrap.Modal.getInstance(modalEl).hide();
            
            document.getElementById('form-datos-fisicos')?.scrollIntoView({
                behavior: 'smooth',
                block: 'start',
            });
        }
    };

    function resetForm() {
        document.getElementById('form-usuario').reset();
        document.getElementById('id').value = 0;
        document.getElementById('imagenPerfilPreview').src = '{{ asset('img/profile-img.jpeg') }}';
    }

    document.getElementById('reset-form-user').addEventListener('click', resetForm);

    document.getElementById('imagenPerfil').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => document.getElementById('imagenPerfilPreview').src = e.target.result;
            reader.readAsDataURL(file);
        }
    });
</script>
{% endblock %}
