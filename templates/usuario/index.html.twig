{% extends 'base.html.twig' %}

{% block title %}Usuarios - SpartaMGym
{% endblock %}

{% block body %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container py-4">
  <div class="card shadow-sm rounded-2 border-1">
    <div class="card-body">
      <h3 class="h4 mb-4 text-primary">Registro de Usuario</h3>

      <form id="form-usuario">
        <input type="hidden" id="id" name="id" value="0">

        <div class="row g-3">
          <!-- Nombre -->
          <div class="col-md-6">
            <label for="nombre" class="form-label">Nombre</label>
            <input type="text" class="form-control rounded-3" id="nombre" name="nombre" placeholder="Ingrese su nombre">
          </div>

          <!-- Cédula -->
          <div class="col-md-6">
            <label for="cedula" class="form-label">Cédula</label>
            <input type="text" class="form-control rounded-3" id="cedula" name="cedula" placeholder="Ingrese su cédula">
          </div>

          <!-- Celular -->
          <div class="col-md-6">
            <label for="celular" class="form-label">Celular</label>
            <input type="tel" class="form-control rounded-3" id="celular" name="celular" placeholder="Ingrese su celular">
          </div>

          <!-- Dirección -->
          <div class="col-md-6">
            <label for="direccion" class="form-label">Dirección</label>
            <input type="text" class="form-control rounded-3" id="direccion" name="direccion" placeholder="Ingrese su dirección">
          </div>

          <!-- Fecha de nacimiento -->
          <div class="col-md-4">
            <label for="fecha_nacimiento" class="form-label">Fecha de nacimiento</label>
            <input type="date" class="form-control rounded-3" id="fecha_nacimiento" name="fecha_nacimiento">
          </div>

          <!-- EPS -->
          <div class="col-md-4">
            <label for="eps" class="form-label">EPS</label>
            <input type="text" class="form-control rounded-3" id="eps" name="eps" placeholder="Ingrese su EPS">
          </div>

          <!-- Correo -->
          <div class="col-md-4">
            <label for="correo" class="form-label">Correo</label>
            <input type="email" class="form-control rounded-3" id="correo" name="correo" placeholder="ejemplo@correo.com">
          </div>
        </div>

        <!-- Botones -->
        <div class="mt-4 d-flex gap-2">
          <button type="submit" class="btn btn-primary btn-sm rounded-pill px-3">Guardar</button>
          <button id="reset-form-user" class="btn btn-outline-secondary btn-sm rounded-pill px-3">Limpiar</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="container py-4">
  <div class="card shadow-sm rounded-2 border-1">
    <div class="card-body">
      <h3 class="h4 mb-4 text-primary">Registro de Medidas Corporales</h3>

      <form id="form-datos-fisicos">
        <div class="row g-3">
          <!-- Cintura -->
          <div class="col-auto">
            <label for="cintura" class="form-label">Cintura (cm)</label>
            <input type="number" class="form-control form-control-sm rounded-3 text-end w-auto"
                   id="cintura" name="cintura" min="0" maxlength="4">
          </div>

          <!-- Glúteos -->
          <div class="col-auto">
            <label for="gluteos" class="form-label">Glúteos (cm)</label>
            <input type="number" class="form-control form-control-sm rounded-3 text-end w-auto"
                   id="gluteos" name="gluteos" min="0" maxlength="4">
          </div>

          <!-- Brazo -->
          <div class="col-auto">
            <label for="brazo" class="form-label">Brazo (cm)</label>
            <input type="number" class="form-control form-control-sm rounded-3 text-end w-auto"
                   id="brazo" name="brazo" min="0" maxlength="4">
          </div>

          <!-- Pecho -->
          <div class="col-auto">
            <label for="pecho" class="form-label">Pecho (cm)</label>
            <input type="number" class="form-control form-control-sm rounded-3 text-end w-auto"
                   id="pecho" name="pecho" min="0" maxlength="4">
          </div>

          <!-- Pierna -->
          <div class="col-auto">
            <label for="pierna" class="form-label">Pierna (cm)</label>
            <input type="number" class="form-control form-control-sm rounded-3 text-end w-auto"
                   id="pierna" name="pierna" min="0" maxlength="4">
          </div>

          <!-- Pantorrilla -->
          <div class="col-auto">
            <label for="pantorrilla" class="form-label">Pantorrilla (cm)</label>
            <input type="number" class="form-control form-control-sm rounded-3 text-end w-auto"
                   id="pantorrilla" name="pantorrilla" min="0" maxlength="4">
          </div>

          <!-- Peso -->
          <div class="col-auto">
            <label for="peso" class="form-label">Peso (kg)</label>
            <input type="number" class="form-control form-control-sm rounded-3 text-end w-auto"
                   id="peso" name="peso" min="0" step="0.1" maxlength="4">
          </div>

          <!-- Altura -->
          <div class="col-auto">
            <label for="altura" class="form-label">Altura (cm)</label>
            <input type="number" class="form-control form-control-sm rounded-3 text-end w-auto"
                   id="altura" name="altura" min="0" step="0.1" maxlength="4">
          </div>

          <!-- IMC -->
          <div class="col-auto">
            <label for="imc" class="form-label">IMC</label>
            <input type="number" class="form-control form-control-sm rounded-3 text-end w-auto"
                   id="imc" name="imc" min="0" step="0.1" maxlength="4">
          </div>
        </div>

        <!-- Botones -->
        <div class="mt-4 d-flex gap-2">
          <button type="submit" class="btn btn-primary btn-sm rounded-pill px-3">Guardar</button>
  
        </div>
      </form>
    </div>
  </div>
</div>



<div class="container mt-4">
	<h3 class="mb-3">Lista de Usuarios</h3>
	<table 
	id="table_usuarios" 
	class="table table-bordered table-hover table-sm" 
	data-toggle="table" data-search="true"
	data-pagination="true" 
	data-page-size="5" 
	data-page-list="[5, 10, 20, All]"
	data-url="{{ path('app_usuario_listar') }}"
	>
		<thead class="table-dark">
			<tr>
				<th data-field="id" data-sortable="true">ID</th>
				<th data-field="nombre" data-sortable="true">Nombre</th>
				<th data-field="cedula">Cédula</th>
				<th data-field="celular">Celular</th>
				<th data-field="direccion">Dirección</th>
				<th data-field="fecha_nacimiento">Fecha Nacimiento</th>
				<th data-field="eps">EPS</th>
				<th data-field="correo">Correo</th>
				<th data-field="code">Código</th>
				<th data-field="img" data-formatter="imgFormatter">Imagen</th>
				<th data-field="operate" data-formatter="accionesFormatter" data-events="operateEvents">Acciones</th>
			</tr>
		</thead>
	</table>
</div>

<script>



	function imgFormatter(value, row, index) {
		if (value) {
			return '<img src="' + value + '" alt="Imagen" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;">';
		} else {
			return 'No disponible';
		}
	}

	function accionesFormatter(value, row, index) {
		return `
				<button class="btn btn-sm btn-primary editar" data-id="${row.id
			}"><i class='bi bi-pencil-square'></i></button>
			`;
	}

	// enviar formulario de usuario
	document.getElementById('form-usuario').addEventListener('submit', function (event) {
		event.preventDefault();
		const formData = new FormData(this);
		fetch('{{ path('app_usuario_registro') }}', {
			method: 'POST',
			body: formData
		}).then(response => response.json()).then(data => {
			if (data.status === 'success') {
				Swal.fire({ title: '¡Éxito!', text: 'El usuario fue guardado correctamente', icon: 'success', confirmButtonText: 'Aceptar' });
				// recargar tabla de usuarios
				$('#table_usuarios').bootstrapTable('refresh');
				// resetear formulario
				resetForm();
			} else {

				Swal.fire({ title: '¡Error!', text: data.message, icon: 'error', confirmButtonText: 'Aceptar' });


			}
		}).catch(error => {
			Swal.fire({ title: '¡Error!', text: error.message, icon: 'error', confirmButtonText: 'Aceptar' });
		});
	});



	// Evento para botón editar
	window.operateEvents = {
		'click .editar': (e, value, row) => { // Llenar el formulario con los datos del usuario
			document.getElementById('id').value = row.id;
			document.getElementById('nombre').value = row.nombre;
			document.getElementById('cedula').value = row.cedula;
			document.getElementById('celular').value = row.celular;
			document.getElementById('direccion').value = row.direccion;
			document.getElementById('fecha_nacimiento').value = row.fecha_nacimiento;
			document.getElementById('eps').value = row.eps;
			document.getElementById('correo').value = row.correo;

			// Desplazar la vista hacia el formulario
			window.scrollTo({ top: 0, behavior: 'smooth' });
		}
	}

	function resetForm() {
		document.getElementById('form-usuario').reset();
		document.getElementById('id').value = 0;
	}
	document.getElementById('reset-form-user').addEventListener('click', function (event) {
		event.preventDefault();
		resetForm();
	});

	document.getElementById('form-datos-fisicos').addEventListener('submit', function (event) {
		event.preventDefault();
		const formData = new FormData(this);
		// agregar id de usuario al formData si el ide es diferente de 0
		let usuarioId = document.getElementById('id').value;
		if (usuarioId && usuarioId != 0) {
			formData.append('id', usuarioId);
		} else {
			Swal.fire({ title: '¡Error!', text: 'Debe seleccionar un usuario para registrar sus datos físicos', icon: 'error', confirmButtonText: 'Aceptar' });
			return;
		}

		fetch('{{ path('app_datos_fisicos_registro') }}', {
			method: 'POST',
			body: formData
		}).then(response => response.json()).then(data => {
			if (data.status === 'success') {
				Swal.fire({ title: '¡Éxito!', text: 'Los datos físicos fueron guardados correctamente', icon: 'success', confirmButtonText: 'Aceptar' });
				// resetear formulario
				this.reset();
				resetForm();
			} else {
				Swal.fire({ title: '¡Error!', text: data.message, icon: 'error', confirmButtonText: 'Aceptar' });
			}
		}).catch(error => {
			console.error('Error al guardar los datos físicos:', error);
			//Swal.fire({ title: '¡Error!', text: error.message, icon: 'error', confirmButtonText: 'Aceptar' });
		});
	});

</script>
{% endblock %}