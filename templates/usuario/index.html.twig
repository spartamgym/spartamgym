{% extends 'base.html.twig' %}

{% block title %}Gestión de Socios - SpartaMGym{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .page-header {
            background: linear-gradient(135deg, #0f172a 0%, #0891b2 100%);
            color: white;
            padding: 2.2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 26px 26px;
            box-shadow: 0 28px 48px -36px rgba(15, 23, 42, 0.9);
        }
        .table-container {
            background: rgba(255, 255, 255, 0.92);
            padding: 1.15rem;
            border-radius: 18px;
            border: 1px solid #dbe6f4;
            box-shadow: 0 20px 34px -30px rgba(15, 23, 42, 0.65);
        }
        .table-container .table {
            font-size: 0.82rem;
        }
        .table-container .table > :not(caption) > * > * {
            padding: 0.42rem 0.46rem;
            white-space: nowrap;
        }
        .table-container .table td:nth-child(2),
        .table-container .table th:nth-child(2) {
            min-width: 170px;
        }
        .btn-rounded {
            border-radius: 10px;
        }
        .profile-img-preview {
            width: 96px;
            height: 96px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid #e2e8f0;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="page-header shadow-sm">
        <div class="container-fluid px-3 px-lg-4 d-flex justify-content-between align-items-center gap-2 flex-wrap">
            <div>
                <h2 class="fw-bold mb-0">Gestión de Socios</h2>
                <p class="mb-0 opacity-75">Registro y administración de socios del gimnasio</p>
            </div>
            <div class="d-flex gap-2">
                <button type="button" id="btn-nuevo-usuario" class="btn btn-light btn-rounded shadow-sm fw-bold">
                    <i class="bi bi-person-plus-fill me-1"></i>Nuevo socio
                </button>
            </div>
        </div>
    </div>

    <div class="container-fluid px-3 px-lg-4 pb-5">
        <div class="table-container shadow-sm">
            <h5 class="fw-bold mb-3"><i class="bi bi-list-ul me-2"></i>Base de Datos de Socios</h5>
            <table
                id="table_usuarios"
                class="table"
                data-toggle="table"
                data-search="true"
                data-pagination="true"
                data-page-size="12"
                data-url="{{ path('app_usuario_listar') }}"
                data-classes="table table-sm table-hover align-middle"
                data-header-style="headerStyle"
            >
                <thead>
                    <tr>
                        <th data-field="id" data-sortable="true" data-width="55">ID</th>
                        <th data-field="nombre" data-sortable="true">Nombre</th>
                        <th data-field="cedula" data-sortable="true">Cédula</th>
                        <th data-field="sexo" data-formatter="sexoFormatter" data-align="center">Sexo</th>
                        <th data-field="celular">Celular</th>
                        <th data-field="code" data-formatter="cardFormatter" data-events="operateEvents">Acceso</th>
                        <th data-field="medida_estandar_nombre" data-formatter="medidaEstandarFormatter">Ref. Objetivo</th>
                        <th data-field="img" data-formatter="imgFormatter" data-align="center">Perfil</th>
                        <th data-field="operate" data-formatter="accionesFormatter" data-events="operateEvents" data-align="center" data-width="125">Acciones</th>
                    </tr>
                </thead>
            </table>
        </div>

    </div>

    <div class="modal fade" id="modal-usuario" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-dark text-white p-4">
                    <h5 class="modal-title fw-bold" id="usuarioModalLabel">
                        <i class="bi bi-person-plus-fill me-2"></i>Registro de socio
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-usuario" class="modal-body p-4">
                    <input type="hidden" id="id" name="id" value="0">

                    <div class="d-flex align-items-center gap-3 mb-4">
                        <img id="imagenPerfilPreview" src="{{ asset('img/profile-img.jpeg') }}" class="profile-img-preview" alt="Foto de perfil">
                        <div class="w-100">
                            <label for="imagenPerfil" class="form-label fw-bold small text-muted text-uppercase">Foto de Perfil</label>
                            <input class="form-control" type="file" id="imagenPerfil" name="imagenPerfil" accept="image/*">
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Nombre Completo</label>
                            <input type="text" class="form-control" id="nombre" name="nombre" required placeholder="Nombre del socio">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Número de Cédula</label>
                            <input type="text" class="form-control" id="cedula" name="cedula" required placeholder="ID Identificación">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Celular / WhatsApp</label>
                            <input type="tel" class="form-control" id="celular" name="celular" placeholder="+57 ...">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Correo Electrónico</label>
                            <input type="email" class="form-control" id="correo" name="correo" placeholder="correo@ejemplo.com">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label small fw-bold">Dirección de Residencia</label>
                            <input type="text" class="form-control" id="direccion" name="direccion" placeholder="Calle, Carrera, Barrio...">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" id="fecha_nacimiento" name="fecha_nacimiento">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">EPS / Salud</label>
                            <input type="text" class="form-control" id="eps" name="eps" placeholder="Entidad de salud">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Sexo</label>
                            <select class="form-select" id="sexo" name="sexo" required>
                                <option value="">Selecciona una opción</option>
                                <option value="F">Femenino</option>
                                <option value="M">Masculino</option>
                                <option value="O">Otro</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button id="reset-form-user" type="button" class="btn btn-light btn-rounded px-4">Limpiar</button>
                        <button type="submit" class="btn btn-success btn-rounded px-4 fw-bold">
                            <i class="bi bi-save me-1"></i>Guardar socio
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-datos-fisicos" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-dark text-white p-4">
                    <h5 class="modal-title fw-bold" id="datosFisicosModalLabel">
                        <i class="bi bi-rulers me-2"></i>Medidas Corporales
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-datos-fisicos" class="modal-body p-4">
                    <input type="hidden" id="id_medida" name="id" value="0">
                    <input type="hidden" id="id_usuario_medida" name="id_usuario" value="0">

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label small mb-1">Peso (kg)</label>
                            <input type="number" step="0.1" class="form-control" name="peso" id="peso">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small mb-1">Altura</label>
                            <input type="number" step="0.1" class="form-control" name="altura" id="altura">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small mb-1">IMC</label>
                            <input type="number" step="0.1" class="form-control" name="imc" id="imc">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small mb-1">Cintura (cm)</label>
                            <input type="number" class="form-control" name="cintura" id="cintura">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small mb-1">Glúteos (cm)</label>
                            <input type="number" class="form-control" name="gluteos" id="gluteos">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small mb-1">Brazo (cm)</label>
                            <input type="number" class="form-control" name="brazo" id="brazo">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small mb-1">Pecho (cm)</label>
                            <input type="number" class="form-control" name="pecho" id="pecho">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small mb-1">Pierna (cm)</label>
                            <input type="number" class="form-control" name="pierna" id="pierna">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small mb-1">Pantorrilla</label>
                            <input type="number" class="form-control" name="pantorrilla" id="pantorrilla">
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button type="button" class="btn btn-light btn-rounded px-4" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary btn-rounded px-4 fw-bold">Guardar Medidas</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="planes-usuario" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-dark text-white p-4">
                    <h5 class="modal-title fw-bold" id="planesUsuarioLabel">Detalle del Socio</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-5">
                        <h6 class="text-muted text-uppercase fw-bold small mb-3">Historial de Membresías</h6>
                        <table class="table table-sm" id="table_planes" data-toggle="table" data-classes="table table-sm table-hover align-middle">
                            <thead>
                                <tr class="bg-light">
                                    <th data-field="nombre">Plan</th>
                                    <th data-field="precio" data-formatter="priceFormatter">Precio</th>
                                    <th data-field="tiempo">Duración</th>
                                    <th data-field="dias_restantes" data-formatter="daysFormatter">Vencimiento</th>
                                    <th data-field="operate" data-formatter="accionesPlanFormatter" data-events="operateEvents" data-align="center">Predeterminado</th>
                                    <th data-field="status_plan" data-formatter="planActivoFormatter" data-align="center">Estado</th>
                                </tr>
                            </thead>
                        </table>
                    </div>

                    <div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-muted text-uppercase fw-bold small mb-0">Histórico de Seguimiento Físico</h6>
                            <button type="button" id="btn-nueva-medida-fisica" class="btn btn-outline-primary btn-sm btn-rounded">
                                <i class="bi bi-plus-circle me-1"></i>Nueva Medida
                            </button>
                        </div>
                        <table class="table table-sm" id="table_medidas" data-toggle="table" data-classes="table table-sm table-hover align-middle">
                            <thead class="small bg-light">
                                <tr>
                                    <th data-field="createAt">Fecha</th>
                                    <th data-field="peso">Peso</th>
                                    <th data-field="altura">Altura</th>
                                    <th data-field="imc">IMC</th>
                                    <th data-field="cintura">Cint.</th>
                                    <th data-field="gluteos">Glut.</th>
                                    <th data-field="brazo">Brazo</th>
                                    <th data-field="pecho">Pecho</th>
                                    <th data-field="pierna">Pierna</th>
                                    <th data-field="operate" data-formatter="accionesFormatterMedidas" data-events="operateEvents" data-align="center">Acción</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    function headerStyle() {
        return { classes: 'bg-light fw-bold text-muted small text-uppercase' };
    }

    function imgFormatter(value) {
        const src = value ? value : '{{ asset('img/profile-img.jpeg') }}';
        return `<img src="${src}" class="rounded-circle shadow-sm" style="width: 36px; height: 36px; object-fit: cover; border: 2px solid white;">`;
    }

    function cardFormatter(value, row) {
        if (!value || value === 'sin asignar') {
            return '<span class="badge bg-light text-muted border">Sin asignar</span>';
        }

        const status = row?.plan_status || 'sin_plan';
        const canMove = status === 'vigente';
        const buttonClass = canMove ? 'btn-success' : (status === 'vencido' ? 'btn-danger' : 'btn-warning');
        const buttonTitle = canMove
            ? 'Registrar ingreso/salida'
            : (status === 'vencido' ? 'Plan vencido: movimiento bloqueado' : 'Sin plan: movimiento bloqueado');

        return `
            <button class="btn btn-sm ${buttonClass} toggle_ingreso fw-semibold px-1 py-0 rounded-0" ${canMove ? '' : 'disabled'} title="${buttonTitle}">
                <i class="bi bi-credit-card-2-front me-1"></i>${value}
            </button>`;
    }

    function medidaEstandarFormatter(value) {
        if (!value || value === 'sin asignar') {
            return '<span class="badge bg-light text-muted border">Sin referencia</span>';
        }
        return `<span class="badge bg-secondary-subtle text-secondary border border-secondary">${value}</span>`;
    }

    function sexoFormatter(value) {
        if (value === 'F') return '<span class="badge bg-info-subtle text-info border border-info">F</span>';
        if (value === 'M') return '<span class="badge bg-primary-subtle text-primary border border-primary">M</span>';
        if (value === 'O') return '<span class="badge bg-warning-subtle text-warning border border-warning">O</span>';
        return '<span class="badge bg-light text-muted border">--</span>';
    }

    function priceFormatter(value) {
        return '<span class="fw-bold">$' + parseInt(value || 0).toLocaleString() + '</span>';
    }

    function daysFormatter(value) {
        const cls = value > 5 ? 'text-success' : 'text-danger fw-bold';
        return `<span class="${cls}">${value} días</span>`;
    }

    function planActivoFormatter(value) {
        if (value === 'vigente') return '<span class="badge bg-success-subtle text-success border border-success px-3">VIGENTE</span>';
        if (value === 'programado') return '<span class="badge bg-warning-subtle text-warning border border-warning px-3">PROGRAMADO</span>';
        return '<span class="badge bg-danger-subtle text-danger border border-danger px-3">VENCIDO</span>';
    }

    function accionesFormatter() {
        return `
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary editar" title="Editar"><i class="bi bi-pencil-fill"></i></button>
                <button class="btn btn-outline-danger desvincular" title="Quitar Tarjeta"><i class="bi bi-link-45deg"></i></button>
                <button class="btn btn-outline-success planes" title="Expediente"><i class="bi bi-eye-fill"></i></button>
            </div>`;
    }

    function accionesPlanFormatter(value, row) {
        return `<i class="bi ${row.is_predefinido ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted'} h5 predefinir" style="cursor:pointer;"></i>`;
    }

    function accionesFormatterMedidas() {
        return `
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary editar_medida" title="Editar medida">
                    <i class="bi bi-pencil-square"></i>
                </button>
                <button class="btn btn-outline-danger eliminar_medida" title="Eliminar medida">
                    <i class="bi bi-trash-fill"></i>
                </button>
            </div>`;
    }

    const modalUsuarioEl = document.getElementById('modal-usuario');
    const modalDatosEl = document.getElementById('modal-datos-fisicos');
    const modalPlanesEl = document.getElementById('planes-usuario');
    let modalUsuario = null;
    let modalDatos = null;
    let modalPlanes = null;
    let shouldRestorePlanesModal = false;
    function getModalUsuario() {
        if (!modalUsuario) {
            modalUsuario = bootstrap.Modal.getOrCreateInstance(modalUsuarioEl);
        }
        return modalUsuario;
    }
    function getModalDatos() {
        if (!modalDatos) {
            modalDatos = bootstrap.Modal.getOrCreateInstance(modalDatosEl);
        }
        return modalDatos;
    }
    function getModalPlanes() {
        if (!modalPlanes) {
            modalPlanes = bootstrap.Modal.getOrCreateInstance(modalPlanesEl);
        }
        return modalPlanes;
    }

    function resetForm() {
        document.getElementById('form-usuario').reset();
        document.getElementById('id').value = 0;
        document.getElementById('imagenPerfilPreview').src = '{{ asset('img/profile-img.jpeg') }}';
        document.getElementById('sexo').value = '';
        document.getElementById('usuarioModalLabel').innerHTML = '<i class="bi bi-person-plus-fill me-2"></i>Registro de socio';
    }

    function resetDatosFisicosForm() {
        document.getElementById('form-datos-fisicos').reset();
        document.getElementById('id_medida').value = 0;
        document.getElementById('datosFisicosModalLabel').innerHTML = '<i class="bi bi-rulers me-2"></i>Medidas Corporales';
    }

    function setUsuarioMedidaSeleccionado(userId) {
        document.getElementById('id_usuario_medida').value = String(userId || 0);
    }

    function openDatosFisicosModal(userId, row = null) {
        resetDatosFisicosForm();
        setUsuarioMedidaSeleccionado(userId);

        if (row) {
            document.getElementById('id_medida').value = row.id || 0;
            document.getElementById('altura').value = row.altura ?? '';
            document.getElementById('peso').value = row.peso ?? '';
            document.getElementById('cintura').value = row.cintura ?? '';
            document.getElementById('gluteos').value = row.gluteos ?? '';
            document.getElementById('brazo').value = row.brazo ?? '';
            document.getElementById('pecho').value = row.pecho ?? '';
            document.getElementById('pierna').value = row.pierna ?? '';
            document.getElementById('pantorrilla').value = row.pantorrilla ?? '';
            document.getElementById('imc').value = row.imc ?? '';
            document.getElementById('datosFisicosModalLabel').innerHTML = '<i class="bi bi-pencil-square me-2"></i>Editar Medidas';
        }

        const planesAbierto = modalPlanesEl.classList.contains('show');
        if (planesAbierto) {
            shouldRestorePlanesModal = true;
            modalPlanesEl.addEventListener('hidden.bs.modal', () => {
                getModalDatos().show();
            }, { once: true });
            getModalPlanes().hide();
            return;
        }

        shouldRestorePlanesModal = false;
        getModalDatos().show();
    }

    document.getElementById('btn-nuevo-usuario').addEventListener('click', () => {
        resetForm();
        setUsuarioMedidaSeleccionado(0);
        getModalUsuario().show();
    });

    document.getElementById('btn-nueva-medida-fisica').addEventListener('click', () => {
        const userId = parseInt(document.getElementById('id_usuario_medida').value || '0', 10);
        if (!userId) {
            Swal.fire('Atención', 'Primero selecciona un socio desde el expediente.', 'warning');
            return;
        }
        openDatosFisicosModal(userId);
    });

    modalDatosEl.addEventListener('hidden.bs.modal', () => {
        if (!shouldRestorePlanesModal) return;
        shouldRestorePlanesModal = false;
        getModalPlanes().show();
    });

    document.getElementById('form-usuario').addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const img = document.getElementById('imagenPerfil').files[0];
        if (img) formData.append('img', img);

        const response = await fetch('{{ path('app_usuario_registro') }}', { method: 'POST', body: formData });
        const data = await response.json();

        if (!response.ok || data.status !== 'success') {
            Swal.fire('Error', data.message || 'No se pudo guardar el socio.', 'error');
            return;
        }

        const instance = bootstrap.Modal.getInstance(modalUsuarioEl);
        if (instance) instance.hide();
        $('#table_usuarios').bootstrapTable('refresh');
        resetForm();
        Swal.fire({ icon: 'success', title: 'Guardado', text: 'Socio registrado/actualizado correctamente', timer: 1800, showConfirmButton: false });
    });

    document.getElementById('form-datos-fisicos').addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const selectedUserId = document.getElementById('id_usuario_medida').value;

        if (!selectedUserId || selectedUserId === '0') {
            Swal.fire('Atención', 'Primero debes seleccionar un socio para guardar sus medidas.', 'warning');
            return;
        }

        formData.set('id_usuario', selectedUserId);

        const data = await enviarDatos("{{ path('app_datos_fisicos_registro') }}", formData);
        if (data && data.status === 'success') {
            const refreshData = new FormData();
            refreshData.append('id', selectedUserId);
            const medidas = await enviarDatos("{{ path('app_usuario_medidas') }}", refreshData);
            if (medidas) {
                $('#table_medidas').bootstrapTable('load', medidas);
            }
            const instance = bootstrap.Modal.getInstance(modalDatosEl);
            if (instance) instance.hide();
            resetDatosFisicosForm();
            Swal.fire({ icon: 'success', title: 'Medidas guardadas', timer: 1500, showConfirmButton: false });
        }
    });

    window.operateEvents = {
        'click .editar': (e, value, row) => {
            resetForm();
            setUsuarioMedidaSeleccionado(row.id);
            document.getElementById('id').value = row.id;
            document.getElementById('imagenPerfilPreview').src = row.img ? row.img : '{{ asset('img/profile-img.jpeg') }}';
            document.getElementById('nombre').value = row.nombre || '';
            document.getElementById('cedula').value = row.cedula || '';
            document.getElementById('celular').value = row.celular || '';
            document.getElementById('direccion').value = row.direccion || '';
            document.getElementById('fecha_nacimiento').value = row.fecha_nacimiento || '';
            document.getElementById('sexo').value = row.sexo || '';
            document.getElementById('eps').value = row.eps || '';
            document.getElementById('correo').value = row.correo || '';
            document.getElementById('usuarioModalLabel').innerHTML = `<i class="bi bi-pencil-square me-2"></i>Editando: ${row.nombre || ''}`;
            getModalUsuario().show();
        },
        'click .desvincular': async (e, value, row) => {
            const result = await Swal.fire({
                title: '¿Desvincular tarjeta?',
                text: 'El socio perderá el acceso físico',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, desvincular'
            });
            if (result.isConfirmed) {
                const formData = new FormData();
                formData.append('id', row.id);
                const data = await enviarDatos("{{ path('app_usuario_desvincular_card') }}", formData);
                if (data && data.status === 'success') {
                    $('#table_usuarios').bootstrapTable('refresh');
                }
            }
        },
        'click .planes': async (e, value, row) => {
            setUsuarioMedidaSeleccionado(row.id);
            const formData = new FormData();
            formData.append('id', row.id);
            const planes = await enviarDatos("{{ path('app_usuario_planes') }}", formData);
            const medidas = await enviarDatos("{{ path('app_usuario_medidas') }}", formData);
            if (planes) $('#table_planes').bootstrapTable('load', planes);
            if (medidas) $('#table_medidas').bootstrapTable('load', medidas);
            document.getElementById('planesUsuarioLabel').innerHTML = `<i class="bi bi-person-vcard me-2"></i>Expediente: ${row.nombre}`;
            getModalPlanes().show();
        },
        'click .predefinir': async (e, value, row) => {
            const formData = new FormData();
            formData.append('id', row.id);
            const data = await enviarDatos("{{ path('app_usuario_plane_predefinir') }}", formData);
            if (data) {
                $('#table_planes').bootstrapTable('load', data);
            }
        },
        'click .toggle_ingreso': async (e, value, row) => {
            if (row.plan_status !== 'vigente') {
                return;
            }

            const formData = new FormData();
            formData.append('id', row.code);
            const data = await enviarDatos("{{ path('app_update_identificador_movimiento') }}", formData);
            if (!data) return;

            if (data.status !== 'success') {
                Swal.fire('Sin acción', data.message || 'No se pudo registrar movimiento.', 'warning');
                return;
            }

            Swal.fire({
                icon: 'success',
                title: data.action === 'salida' ? 'Salida registrada' : 'Ingreso registrado',
                text: data.message || 'Movimiento registrado correctamente.',
                timer: 1600,
                showConfirmButton: false
            });
        },
        'click .editar_medida': (e, value, row) => {
            const userId = parseInt(document.getElementById('id_usuario_medida').value || '0', 10);
            if (!userId) {
                Swal.fire('Atención', 'No se detectó el socio para esta medida.', 'warning');
                return;
            }
            openDatosFisicosModal(userId, row);
        },
        'click .eliminar_medida': async (e, value, row) => {
            const userId = parseInt(document.getElementById('id_usuario_medida').value || '0', 10);
            if (!userId || !row.id) {
                Swal.fire('Atención', 'No se pudo identificar la medida a eliminar.', 'warning');
                return;
            }

            const result = await Swal.fire({
                title: '¿Eliminar medida?',
                text: 'Esta acción no se puede deshacer.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc3545'
            });
            if (!result.isConfirmed) return;

            const formData = new FormData();
            formData.append('id', row.id);

            try {
                const response = await fetch('{{ path('app_usuario_medidas_eliminar') }}', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (!response.ok || data.status !== 'success') {
                    Swal.fire('Error', data.message || 'No se pudo eliminar la medida.', 'error');
                    return;
                }

                const refreshData = new FormData();
                refreshData.append('id', userId);
                const medidas = await enviarDatos("{{ path('app_usuario_medidas') }}", refreshData);
                if (medidas) {
                    $('#table_medidas').bootstrapTable('load', medidas);
                }
                Swal.fire({ icon: 'success', title: 'Medida eliminada', timer: 1500, showConfirmButton: false });
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'No se pudo conectar con el servidor.', 'error');
            }
        }
    };

    document.getElementById('reset-form-user').addEventListener('click', resetForm);

    document.getElementById('imagenPerfil').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => document.getElementById('imagenPerfilPreview').src = e.target.result;
            reader.readAsDataURL(file);
        }
    });

</script>
{% endblock %}
