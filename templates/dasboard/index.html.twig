{% extends 'base.html.twig' %}

{% block title %}Panel en Tiempo Real - SpartaMGym{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .dashboard-top-bar {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #dbe6f4;
            border-radius: 18px;
            padding: 1rem 1.15rem;
            margin: 1.2rem auto 2rem;
            box-shadow: 0 20px 34px -30px rgba(15, 23, 42, 0.65);
            backdrop-filter: blur(8px);
        }
        .profile-header-card {
            background: linear-gradient(140deg, #0f172a 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 20px;
            box-shadow: 0 26px 44px -34px rgba(15, 23, 42, 0.9);
        }
        .profile-img-lg {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border: 4px solid rgba(255,255,255,0.2);
            padding: 4px;
        }
        .nav-pills-custom .nav-link {
            color: #64748b !important;
            font-weight: 600;
            border-radius: 11px;
            padding: 0.72rem 1.15rem;
            transition: all 0.2s;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
        }
        .nav-pills-custom .nav-link:hover {
            color: #1e293b !important;
            background-color: #eef2ff;
        }
        .nav-pills-custom .nav-link.active {
            background: linear-gradient(120deg, #1d4ed8 0%, #2563eb 100%);
            color: white !important;
            border-color: transparent;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
        }
        .info-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #94a3b8;
            margin-bottom: 0.25rem;
        }
        .info-value {
            color: #1e293b;
            font-weight: 600;
        }
        .card-plan-active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 15px;
        }
        .queue-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            padding: 0.35em 0.65em;
        }
        .btn-ai {
            background: linear-gradient(120deg, #1d4ed8 0%, #0891b2 100%);
            color: white;
            border: none;
            padding: 0.8rem;
            transition: all 0.3s;
            box-shadow: 0 14px 30px -24px rgba(29, 78, 216, 0.78);
        }
        .btn-ai:hover {
            background: linear-gradient(120deg, #1e40af 0%, #0e7490 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 18px 28px -22px rgba(29, 78, 216, 0.85);
        }
        .ai-content-wrapper {
            line-height: 1.6;
            color: #334155;
        }
        .ai-content-wrapper h1, .ai-content-wrapper h2, .ai-content-wrapper h3 {
            color: #1e293b;
            font-weight: 700;
            margin-top: 1.5rem;
        }
        .ai-history-item {
            border-left: 4px solid #0ea5e9;
            border-radius: 10px;
            padding: 0.85rem 1rem;
            margin-bottom: 0.75rem;
            background: #f8fafc;
        }
        .queue-side-card {
            border-radius: 18px;
            border: 1px solid #dbe6f4;
            background: rgba(255, 255, 255, 0.9);
        }
        .queue-scroll-container {
            max-height: 340px;
            overflow-y: auto;
            padding-right: 0.25rem;
        }
        .queue-scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .queue-scroll-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 999px;
        }
        .queue-item {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.6rem 0.7rem;
            margin-bottom: 0.55rem;
            background: #f8fbff;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .queue-item:hover {
            border-color: #93c5fd;
            box-shadow: 0 12px 24px -22px rgba(30, 64, 175, 0.65);
        }
        .radar-wrapper {
            position: relative;
            height: 340px;
        }
        .card.card-custom {
            background: rgba(255, 255, 255, 0.92);
        }
        @media (max-width: 992px) {
            .dashboard-top-bar {
                margin-inline: 0.5rem;
            }
        }
    </style>
{% endblock %}

{% block body %}
    <div class="dashboard-top-bar shadow-sm">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0 rounded-start-pill px-3">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input id="input-buscar" type="text" class="form-control bg-light border-start-0 rounded-end-pill" placeholder="Buscar socio por cédula...">
                        <button class="btn btn-primary rounded-pill ms-2 px-4 fw-bold" id="btn-buscar">Buscar</button>
                    </div>
                </div>
                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    <span class="text-muted small me-3"><i class="bi bi-circle-fill text-success small me-1"></i> Sistema en línea</span>
                    <a href="{{ path('app_panel') }}" class="btn btn-light btn-rounded shadow-sm">
                        <i class="bi bi-grid-fill"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container pb-5">
        <div class="row g-4">
            <!-- Sidebar: Perfil Resumido -->
            <div class="col-xl-4">
                <div class="card profile-header-card shadow-sm mb-4">
                    <div class="card-body text-center p-5">
                        <img id="img-perfil" src="{{ asset('img/profile-img.jpeg') }}" alt="Socio" class="profile-img-lg rounded-circle shadow-lg mb-3">
                        <h4 id="nombre-perfil" class="fw-bold mb-1">Cargando...</h4>
                        <p id="cedula-badge" class="badge bg-primary-subtle text-primary rounded-pill px-3 mb-4">ID: --</p>
                        
                        <div id="accordionPlanes">
                            <!-- Plan activo se carga aquí -->
                        </div>

                        <button type="button" class="btn btn-ai w-100 mt-4 rounded-pill fw-bold shadow-sm" onclick="checkUserBeforeModal()">
                            <i class="bi bi-magic me-2"></i>Generar rutina IA
                        </button>
                    </div>
                </div>

                <div class="card queue-side-card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold"><i class="bi bi-people-fill me-2 text-primary"></i>Socios Adentro</h6>
                            <span class="badge text-bg-primary rounded-pill" id="cola-count-left">0</span>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        <div class="queue-scroll-container" id="lista-encola-left">
                            <p class="text-muted small mb-0">No hay socios dentro del gimnasio.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Formulario IA -->
            <div class="modal fade" id="modalIA" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg rounded-4">
                        <div class="modal-header bg-dark text-white border-0 py-3">
                            <h5 class="modal-title fw-bold"><i class="bi bi-pencil-square me-2"></i>Datos para rutina IA</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <form id="form-ia-plan">
                                <div class="mb-3">
                                    <label class="form-label small fw-bold text-muted">Nombre Completo</label>
                                    <input type="text" class="form-control" name="fullName" id="ai-fullName" readonly>
                                </div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">Días Disponibles/Semana</label>
                                        <input type="number" class="form-control" name="availableDays" min="1" max="7" value="3" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">Nivel Actual</label>
                                        <select class="form-select" name="currentLevel">
                                            <option value="principiante">Principiante</option>
                                            <option value="intermedio" selected>Intermedio</option>
                                            <option value="avanzado">Avanzado</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">Minutos por Sesión</label>
                                        <input type="number" class="form-control" name="timePerSessionMin" value="45" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">Peso (kg)</label>
                                        <input type="number" class="form-control" name="weight" id="ai-weight" required>
                                    </div>
                                </div>
                                <div class="mb-3 form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="ai-hasDisabilities" name="hasDisabilities">
                                    <label class="form-check-label small fw-bold text-muted" for="ai-hasDisabilities">¿Tiene alguna discapacidad/lesión?</label>
                                </div>
                                <div class="mb-3 d-none" id="div-disabilityDescription">
                                    <label class="form-label small fw-bold text-muted">Descripción de la discapacidad</label>
                                    <textarea class="form-control" name="disabilityDescription" rows="2" placeholder="Ej: Lesión en rodilla izquierda..."></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small fw-bold text-muted">Información Adicional (Objetivos)</label>
                                    <textarea class="form-control" name="additionalInfo" rows="2" placeholder="Ej: Ganar masa muscular, bajar de peso..."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer border-0 p-4 pt-0">
                            <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" id="btn-confirm-ia" class="btn btn-ai rounded-pill px-4 fw-bold">Generar rutina</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido Principal: Tabs -->
            <div class="col-xl-8">
                <div class="card card-custom border-0 shadow-sm overflow-hidden">
                    <div class="card-header bg-white border-0 pt-4 px-4">
                        <ul class="nav nav-pills nav-pills-custom gap-2" id="pills-tab" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#profile-overview">
                                    <i class="bi bi-person-vcard me-2"></i>Información
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#profile-edit">
                                    <i class="bi bi-graph-up me-2"></i>Evolución Física
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#profile-settings">
                                    <i class="bi bi-clock-history me-2"></i>Historial de planes
                                </button>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="card-body p-4">
                        <div class="tab-content">
                            <!-- Tab: Información General -->
                            <div class="tab-pane fade show active" id="profile-overview">
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="p-3 bg-light rounded-4 h-100">
                                            <div class="info-label">Nombre Completo</div>
                                            <div class="info-value h5 mb-0" id="nombre">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="p-3 bg-light rounded-4 h-100">
                                            <div class="info-label">Contacto / WhatsApp</div>
                                            <div class="info-value h5 mb-0" id="celular">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="p-3 bg-light rounded-4 h-100">
                                            <div class="info-label">Dirección</div>
                                            <div class="info-value mb-0" id="direccion">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="p-3 bg-light rounded-4 h-100">
                                            <div class="info-label">Fecha Nacimiento</div>
                                            <div class="info-value mb-0" id="fecha_nacimiento">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="p-3 bg-light rounded-4 h-100">
                                            <div class="info-label">Seguridad Social (EPS)</div>
                                            <div class="info-value mb-0" id="eps">--</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="p-3 bg-light rounded-4 h-100">
                                            <div class="info-label">Email</div>
                                            <div class="info-value mb-0 small" id="correo">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab: Gráfico y Tabla de Medidas -->
                            <div class="tab-pane fade" id="profile-edit">
                                <div class="row align-items-center">
                                    <div class="col-lg-6">
                                        <div class="p-3 radar-wrapper">
                                            <canvas id="radarMedidas"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover" id="table_menu" data-toggle="table">
                                                <thead class="small text-uppercase text-muted bg-light">
                                                    <tr>
                                                        <th data-field="createAt" data-formatter="dateFormatter">Fecha</th>
                                                        <th data-field="peso">Peso</th>
                                                        <th data-field="imc">IMC</th>
                                                        <th data-field="cintura">Cint.</th>
                                                    </tr>
                                                </thead>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab: Planes -->
                            <div class="tab-pane fade" id="profile-settings">
                                <table class="table" id="table_planes" data-toggle="table" data-classes="table table-hover">
                                    <thead class="bg-light">
                                        <tr>
                                            <th data-field="nombre">Plan</th>
                                            <th data-field="precio" data-formatter="priceFormatter">Precio</th>
                                            <th data-field="dias_restantes">Días</th>
                                            <th data-field="status_plan" data-formatter="activoFormatter" data-align="center">Estado</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nueva Sección: Resultado IA -->
        <div class="row mt-5" id="section-ai-plan" style="display: none;">
            <div class="col-12">
                <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                    <div class="card-header bg-dark text-white p-4 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-robot me-2 text-info"></i>Rutina personalizada (IA)</h5>
                        <div class="d-flex align-items-center">
                            <button id="btn-pdf-download" class="btn btn-sm btn-primary rounded-pill px-3 me-2 fw-bold">
                                <i class="bi bi-file-earmark-pdf me-1"></i>Descargar PDF
                            </button>
                            <button id="btn-whatsapp-share" class="btn btn-sm btn-success rounded-pill px-3 me-3 fw-bold">
                                <i class="bi bi-whatsapp me-1"></i>Enviar por WhatsApp
                            </button>
                            <button class="btn btn-sm btn-outline-light rounded-circle" onclick="document.getElementById('section-ai-plan').style.display='none'">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-5 bg-white ai-content-wrapper" id="ai-plan-content">
                        <!-- El contenido se cargará aquí -->
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4" id="section-ai-history" style="display: none;">
            <div class="col-12">
                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-light border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold"><i class="bi bi-journal-text me-2"></i>Rutinas Generadas</h6>
                            <small class="text-muted" id="ai-rutinas-meta">0/2 este mes</small>
                        </div>
                    </div>
                    <div class="card-body" id="ai-rutinas-list">
                        <p class="text-muted small mb-0">Sin rutinas generadas para este socio.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    let currentRutinaId = null;
    let currentRutinaPdfUrl = null;
    let currentUsuarioCedula = null;

    function escapeHtml(value) {
        return String(value || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    async function cargarRutinasPorCedula(cedula) {
        const section = document.getElementById('section-ai-history');
        const meta = document.getElementById('ai-rutinas-meta');
        const list = document.getElementById('ai-rutinas-list');

        if (!cedula) {
            section.style.display = 'none';
            return;
        }

        try {
            const response = await fetch(`{{ path('app_dashboard_ai_rutinas') }}?cedula=${encodeURIComponent(cedula)}&limit=20`);
            const data = await response.json();
            if (!response.ok || data.status === 'error') {
                throw new Error(data.message || 'No fue posible cargar historial de rutinas.');
            }

            const limite = data.limite_mensual || {};
            const max = Number(limite.max || 2);
            const usadas = Number(limite.usadas || 0);
            meta.textContent = `${usadas}/${max} este mes`;

            const items = Array.isArray(data.items) ? data.items : [];
            if (items.length === 0) {
                list.innerHTML = '<p class="text-muted small mb-0">Sin rutinas generadas para este socio.</p>';
            } else {
                list.innerHTML = items.map((item) => {
                    const fecha = item.created_at ? new Date(item.created_at).toLocaleString() : '--';
                    const preview = escapeHtml(item.preview || '');
                    const pdfButton = item.pdf_download_url
                        ? `<a class="btn btn-sm btn-outline-primary rounded-pill" href="${item.pdf_download_url}" target="_blank"><i class="bi bi-file-earmark-pdf me-1"></i>PDF</a>`
                        : '<span class="badge bg-secondary-subtle text-secondary">Sin PDF</span>';
                    return `
                        <div class="ai-history-item">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <strong class="small text-dark">Rutina #${item.id}</strong>
                                <small class="text-muted">${fecha}</small>
                            </div>
                            <div class="small text-muted mb-2">${preview || 'Sin resumen.'}</div>
                            <div>${pdfButton}</div>
                        </div>`;
                }).join('');
            }

            section.style.display = 'block';
        } catch (error) {
            console.error(error);
            list.innerHTML = '<p class="text-danger small mb-0">No fue posible cargar el historial de rutinas.</p>';
            section.style.display = 'block';
        }
    }

    // Validar usuario antes de abrir el modal
    function checkUserBeforeModal() {
        const fullName = document.getElementById('ai-fullName').value;
        if (!fullName || fullName === "Cargando..." || fullName === "") {
            Swal.fire({ 
                icon: 'warning', 
                title: 'Acción bloqueada', 
                text: 'Primero debes cargar el perfil de un socio (mediante búsqueda o ingreso) para generar su rutina personalizada.'
            });
            return;
        }
        const modal = new bootstrap.Modal(document.getElementById('modalIA'));
        modal.show();
    }

    // Manejo del formulario de IA
    document.getElementById('ai-hasDisabilities').addEventListener('change', function() {
        document.getElementById('div-disabilityDescription').classList.toggle('d-none', !this.checked);
    });

    document.getElementById('btn-confirm-ia').addEventListener('click', async function() {
        const btn = this;
        const fullName = document.getElementById('ai-fullName').value;

        if (!fullName || fullName === "Cargando...") {
            Swal.fire({ 
                icon: 'warning', 
                title: 'Socio no detectado', 
                text: 'Por favor, busca un socio o espera a que se cargue uno mediante el ingreso para generar una rutina.' 
            });
            return;
        }

        const form = document.getElementById('form-ia-plan');
        const formData = new FormData(form);
        const data = {};
        
        formData.forEach((value, key) => {
            if (key === 'hasDisabilities') {
                data[key] = true;
            } else if (key === 'availableDays' || key === 'timePerSessionMin' || key === 'weight') {
                data[key] = parseInt(value);
            } else {
                data[key] = value;
            }
        });
        
        if (!data.hasDisabilities) {
            data.hasDisabilities = false;
            data.disabilityDescription = false;
        }
        if (!data.additionalInfo) data.additionalInfo = false;
        data.cedula = (document.getElementById('cedula-badge').textContent || '').replace('ID:', '').trim();

        const originalContent = btn.innerHTML;
        const section = document.getElementById('section-ai-plan');
        const contentDiv = document.getElementById('ai-plan-content');
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalIA'));

        try {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generando...';
            
            const response = await fetch("{{ path('app_dashboard_ai_rutina') }}", { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (!response.ok || result.status === 'error') {
                throw new Error(result.message || 'Error de backend');
            }

            modal.hide();
            section.style.display = 'block';
            const formattedContent = result.content_html || '';
            contentDiv.innerHTML = formattedContent;
            currentRutinaId = result.rutina?.id || null;
            currentRutinaPdfUrl = result.rutina?.pdf_download_url || null;
            currentUsuarioCedula = data.cedula || currentUsuarioCedula;
            if (currentUsuarioCedula) {
                cargarRutinasPorCedula(currentUsuarioCedula);
            }
            
            section.scrollIntoView({ behavior: 'smooth' });
            const limite = result.limite_mensual || {};
            const limiteTexto = limite.max
                ? `Rutinas este mes: ${limite.usadas || 0}/${limite.max}.`
                : 'Tu rutina ha sido generada con éxito.';
            Swal.fire({ icon: 'success', title: '¡Listo!', text: limiteTexto, timer: 2500 });

        } catch (error) {
            console.error(error);
            Swal.fire({ icon: 'error', title: 'Error', text: error.message || 'Ocurrió un error al generar la rutina.' });
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }
    });

    // Compartir por WhatsApp
    document.getElementById('btn-whatsapp-share').addEventListener('click', function() {
        const content = document.getElementById('ai-plan-content').innerText;
        const phone = document.getElementById('celular').innerText.replace(/\D/g, ''); // Solo números
        const name = document.getElementById('nombre').innerText;
        
        if (!content && !currentRutinaPdfUrl) return;

        const header = `*RUTINA IA SPARTAMGYM - ${name}*\n\n`;
        const pdfLine = currentRutinaPdfUrl ? `\n\nPDF: ${currentRutinaPdfUrl}` : '';
        const text = encodeURIComponent(header + content + pdfLine);
        const url = `https://api.whatsapp.com/send?phone=${phone}&text=${text}`;
        
        window.open(url, '_blank');
    });

    document.getElementById('btn-pdf-download').addEventListener('click', async function() {
        const content = document.getElementById('ai-plan-content').innerHTML;
        const nombre = document.getElementById('nombre').innerText || 'socio';
        if (!content || content.trim() === '') {
            Swal.fire({ icon: 'warning', title: 'Sin contenido', text: 'Genera una rutina antes de exportar.' });
            return;
        }

        try {
            const response = await fetch("{{ path('app_dashboard_ai_pdf') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    rutina_id: currentRutinaId,
                    nombre,
                    content
                })
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.message || 'No fue posible generar el PDF.');
            }

            const blob = await response.blob();
            const rutinaDownloadUrl = response.headers.get('X-Rutina-Download-Url');
            if (rutinaDownloadUrl) {
                currentRutinaPdfUrl = rutinaDownloadUrl;
            }
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rutina-${nombre.replace(/\s+/g, '-').toLowerCase()}.pdf`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            if (currentUsuarioCedula) {
                cargarRutinasPorCedula(currentUsuarioCedula);
            }
        } catch (error) {
            Swal.fire({ icon: 'error', title: 'Error', text: error.message || 'No fue posible exportar PDF.' });
        }
    });

	const imgPerfil = document.getElementById('img-perfil');
	const nombrePerfil = document.getElementById('nombre-perfil');
    function applyQueue(queueItems) {
        const listaEncola = document.getElementById("lista-encola");
        const listaEncolaLeft = document.getElementById("lista-encola-left");
        const colaCount = document.getElementById("cola-count");
        const colaCountLeft = document.getElementById("cola-count-left");
        if (listaEncola) {
            listaEncola.innerHTML = '<li class="dropdown-header text-uppercase fw-bold small">Socios dentro del gimnasio</li>';
        }
        listaEncolaLeft.innerHTML = '';

        const cards = Array.isArray(queueItems) ? queueItems : [];
        if (cards.length === 0) {
            if (listaEncola) {
                listaEncola.innerHTML += '<li class="dropdown-item-text text-muted small">No hay socios dentro del gimnasio.</li>';
            }
            listaEncolaLeft.innerHTML = '<p class="text-muted small mb-0">No hay socios dentro del gimnasio.</p>';
        }

        cards.forEach(({ code, usuario }) => {
            if (listaEncola) {
                const li = document.createElement("li");
                li.className = "dropdown-item d-flex justify-content-between align-items-center py-2 border-bottom border-light";
                li.innerHTML = `
                    <div class="me-3">
                        <div class="fw-bold small text-dark">${usuario?.nombre || '--'}</div>
                        <div class="text-muted" style="font-size: 0.7rem;">Cédula: ${usuario?.cedula || '--'}</div>
                    </div>
                    <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-light border" onclick="verDesdeCola('${code}')">
                            <i class="bi bi-eye-fill text-primary"></i>
                        </button>
                        <button class="btn btn-sm btn-light border" onclick="salidaRapidaDesdeCola('${code}')">
                            <i class="bi bi-box-arrow-right text-danger"></i>
                        </button>
                    </div>`;
                listaEncola.appendChild(li);
            }

            const row = document.createElement("div");
            row.className = "queue-item";
            row.innerHTML = `
                <div class="d-flex justify-content-between align-items-start gap-2">
                    <div>
                        <div class="fw-bold small text-dark">${usuario?.nombre || '--'}</div>
                        <div class="text-muted" style="font-size: 0.78rem;">Cédula: ${usuario?.cedula || '--'}</div>
                    </div>
                    <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-outline-primary rounded-pill px-2" title="Ver perfil" onclick="verDesdeCola('${code}')">
                            <i class="bi bi-eye-fill"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger rounded-pill px-2" title="Registrar salida" onclick="salidaRapidaDesdeCola('${code}')">
                            <i class="bi bi-box-arrow-right"></i>
                        </button>
                    </div>
                </div>`;
            listaEncolaLeft.appendChild(row);
        });
        if (colaCount) {
            colaCount.textContent = cards.length;
        }
        colaCountLeft.textContent = cards.length;
    }

    function applyUserProfile(userData) {
        if (!userData || typeof userData !== 'object') {
            return;
        }

        const datofisicos = Array.isArray(userData.datofisicos) ? userData.datofisicos : [];
        const planesRaw = Array.isArray(userData.planes) ? userData.planes : [];

        imgPerfil.src = userData.img || '{{ asset('img/profile-img.jpeg') }}';
        nombrePerfil.textContent = userData.nombre;
        document.getElementById('cedula-badge').textContent = 'ID: ' + userData.cedula;
        document.getElementById('nombre').textContent = userData.nombre;
        document.getElementById('celular').textContent = userData.celular;
        document.getElementById('direccion').textContent = userData.direccion;
        document.getElementById('fecha_nacimiento').textContent = userData.fecha_nacimiento;
        document.getElementById('eps').textContent = userData.eps;
        document.getElementById('correo').textContent = userData.correo;
        currentUsuarioCedula = userData.cedula || null;
        currentRutinaId = null;
        currentRutinaPdfUrl = null;
        if (currentUsuarioCedula) {
            cargarRutinasPorCedula(currentUsuarioCedula);
        }

        const medidaComparacion = userData.medida_estandar && typeof userData.medida_estandar === 'object'
            ? userData.medida_estandar
            : null;

        document.getElementById('ai-fullName').value = userData.nombre;
        if (datofisicos.length > 0) {
            document.getElementById('ai-weight').value = datofisicos[datofisicos.length - 1].peso;
        } else if (medidaComparacion && medidaComparacion.peso) {
            document.getElementById('ai-weight').value = medidaComparacion.peso;
        }
        crearOActualizarGrafica(datofisicos, medidaComparacion);

        $('#table_menu').bootstrapTable('load', datofisicos);

        const planes = planesRaw.map(item => ({
            ...item,
            detalle: Array.isArray(item.detalle) ? item.detalle.join(",") : ''
        }));
        $('#table_planes').bootstrapTable('load', planes);

        const mainPlan =
            planesRaw.find(p => p.is_predefinido) ||
            planesRaw.find(p => p.status_plan === 'vigente') ||
            planesRaw.find(p => p.status_plan === 'programado') ||
            planesRaw[0] ||
            null;
        const container = document.getElementById("accordionPlanes");
        if (!mainPlan) {
            container.innerHTML = `
                <div class="card card-plan-active bg-danger shadow-sm mt-3">
                    <div class="card-body p-3">
                        <h6 class="text-uppercase fw-bold small opacity-75 mb-1">Estado de Membresía</h6>
                        <div class="h5 mb-0">INACTIVO / SIN PLAN</div>
                    </div>
                </div>`;
        } else if (mainPlan.status_plan === 'programado') {
            container.innerHTML = `
                <div class="card card-plan-active bg-warning shadow-sm mt-3">
                    <div class="card-body p-3 text-start">
                        <h6 class="text-uppercase fw-bold small opacity-75 mb-1">Membresía Programada</h6>
                        <div class="h5 mb-0">${mainPlan.nombre}</div>
                        <div class="small opacity-75 mt-1">Inicia: ${mainPlan.fecha_inicio || '--'}</div>
                    </div>
                </div>`;
        } else if (mainPlan.status_plan === 'vigente') {
            const { nombre, precio } = mainPlan;
            container.innerHTML = `
                <div class="card card-plan-active shadow-sm mt-3">
                    <div class="card-body p-3 text-start">
                        <h6 class="text-uppercase fw-bold small opacity-75 mb-1">Membresía Vigente</h6>
                        <div class="h5 mb-0">${nombre}</div>
                        <div class="small opacity-75 mt-1">$${Number(precio).toLocaleString()} COP</div>
                    </div>
                </div>`;
        } else {
            container.innerHTML = `
                <div class="card card-plan-active bg-danger shadow-sm mt-3">
                    <div class="card-body p-3 text-start">
                        <h6 class="text-uppercase fw-bold small opacity-75 mb-1">Membresía Vencida</h6>
                        <div class="h5 mb-0">${mainPlan.nombre}</div>
                    </div>
                </div>`;
        }
    }

    function handleRealtimePayload(payload) {
        if (!payload || typeof payload !== 'object') return;

        if (payload.type === 'queue.updated') {
            applyQueue(payload.queue);
            return;
        }

        if (payload.type === 'user.selected') {
            applyUserProfile(payload.user || null);
            return;
        }

        // Compatibilidad con payload legado
        if (Array.isArray(payload.cards)) {
            applyQueue(payload.cards);
        }
        if (payload.nombre) {
            applyUserProfile(payload);
        }
    }

    async function loadRealtimeSnapshot() {
        try {
            const response = await fetch("{{ path('app_dashboard_realtime_snapshot') }}");
            if (!response.ok) return;
            const payload = await response.json();
            applyQueue(payload.queue || payload.cards || []);
            if (payload.user) {
                applyUserProfile(payload.user);
            }
        } catch (error) {
            console.error('Error snapshot realtime:', error);
        }
    }

    const eventSource = new EventSource(
        "{{ mercure(mercure_topic, { subscribe: [mercure_topic] })|e('js') }}",
        { withCredentials: true }
    );
    eventSource.onmessage = (event) => {
        try {
            handleRealtimePayload(JSON.parse(event.data));
        } catch (error) {
            console.error('Error Mercure:', error);
        }
    };
    eventSource.onerror = () => {
        console.warn('Conexion Mercure inestable. Reintentando...');
    };

    loadRealtimeSnapshot();

	let radarChart = null;
    let radarSnapshot = {
        datos: [],
        medidaEstandar: null
    };

    function normalizarValorRadar(value) {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : 0;
    }

    function mapValoresRadar(source = {}) {
        return [
            normalizarValorRadar(source.peso),
            normalizarValorRadar(source.cintura),
            normalizarValorRadar(source.gluteos),
            normalizarValorRadar(source.brazo),
            normalizarValorRadar(source.pecho),
            normalizarValorRadar(source.pierna),
            normalizarValorRadar(source.pantorrilla),
            normalizarValorRadar(source.altura),
            normalizarValorRadar(source.imc)
        ];
    }

    function construirDatasetsRadar(datos, medidaEstandar = null) {
        const datasets = [];

        if (medidaEstandar) {
            datasets.push({
                label: `Referencia: ${medidaEstandar.nombre || 'Estándar'}`,
                data: mapValoresRadar(medidaEstandar),
                fill: false,
                borderDash: [6, 3],
                borderColor: '#dc2626',
                backgroundColor: 'rgba(220, 38, 38, 0.08)',
                pointBackgroundColor: '#dc2626'
            });
        }

        const mediciones = Array.isArray(datos) ? datos.slice(-3) : [];
        mediciones.forEach((d, index) => {
            const fechaRaw = d.createAt || d.UpdateAt || null;
            const fechaLabel = fechaRaw ? new Date(fechaRaw).toLocaleDateString() : `Medición ${index + 1}`;
            datasets.push({
                label: fechaLabel,
                data: mapValoresRadar(d),
                fill: true,
                backgroundColor: d.color ? `${d.color}33` : 'rgba(59, 130, 246, 0.2)',
                borderColor: d.color || '#3b82f6',
                pointBackgroundColor: d.color || '#3b82f6'
            });
        });

        if (datasets.length === 0) {
            datasets.push({
                label: 'Sin datos',
                data: [0, 0, 0, 0, 0, 0, 0, 0, 0],
                fill: true,
                backgroundColor: 'rgba(148, 163, 184, 0.12)',
                borderColor: '#94a3b8',
                pointBackgroundColor: '#94a3b8'
            });
        }

        return datasets;
    }

    function renderRadarChart(forceResize = false) {
        const canvas = document.getElementById('radarMedidas');
        if (!canvas || typeof Chart === 'undefined') {
            return;
        }

        const labels = ['Peso', 'Cintura', 'Glúteos', 'Brazo', 'Pecho', 'Pierna', 'Pantorrilla', 'Altura', 'IMC'];
        const datasets = construirDatasetsRadar(radarSnapshot.datos, radarSnapshot.medidaEstandar);

        if (radarChart) {
            radarChart.data.labels = labels;
            radarChart.data.datasets = datasets;
            radarChart.update();
            if (forceResize) {
                radarChart.resize();
            }
            return;
        }

        const ctx = canvas.getContext('2d');
        if (!ctx) {
            return;
        }

        radarChart = new Chart(ctx, {
            type: 'radar',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        grid: { color: '#e2e8f0' }
                    }
                },
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        if (forceResize) {
            radarChart.resize();
        }
    }

	function crearOActualizarGrafica(datos, medidaEstandar = null) {
        radarSnapshot = {
            datos: Array.isArray(datos) ? datos : [],
            medidaEstandar: medidaEstandar && typeof medidaEstandar === 'object' ? medidaEstandar : null
        };
        renderRadarChart(false);
	}

    document.addEventListener('shown.bs.tab', function (event) {
        const tabTarget = event.target?.getAttribute('data-bs-target');
        if (tabTarget === '#profile-edit') {
            setTimeout(() => renderRadarChart(true), 80);
        }
    });

    window.addEventListener('resize', () => {
        if (radarChart) {
            radarChart.resize();
        }
    });

	document.getElementById('btn-buscar').addEventListener('click', async () => {
		const query = document.getElementById('input-buscar').value;
		if (!query) return;
		const formData = new FormData();
		formData.append('id', query);
		const data = await enviarDatos("{{ path('app_home_updated_dash_cedula') }}", formData);
        if (data && data.user) {
            applyUserProfile(data.user);
        }
	});

	    function priceFormatter(value) { return '$' + Number(value).toLocaleString(); }
    function dateFormatter(value) { return new Date(value).toLocaleDateString(); }
	function activoFormatter(value) {
		if (value === 'vigente') return '<span class="text-success fw-bold">Vigente</span>';
		if (value === 'programado') return '<span class="text-warning fw-bold">Programado</span>';
		return '<span class="text-danger fw-bold">Vencido</span>';
	}

	async function verDesdeCola(code) {
		const formData = new FormData();
		formData.append('id', code);
		const data = await enviarDatos("{{ path('app_home_updated_dash') }}", formData);
        if (data && data.user) {
            applyUserProfile(data.user);
        }
	}

    async function salidaRapidaDesdeCola(code) {
        const confirm = await Swal.fire({
            icon: 'question',
            title: 'Registrar salida',
            text: '¿Deseas registrar la salida de este socio?',
            showCancelButton: true,
            confirmButtonText: 'Sí, registrar',
            cancelButtonText: 'Cancelar'
        });
        if (!confirm.isConfirmed) return;

        const formData = new FormData();
        formData.append('id', code);
        const data = await enviarDatos("{{ path('app_update_identificador_salida') }}", formData);
        if (data?.status === 'success') {
            Swal.fire({ icon: 'success', title: 'Salida registrada', text: data.message || 'Salida registrada correctamente.', timer: 1800 });
        } else if (data?.message) {
            Swal.fire({ icon: 'warning', title: 'No se registró salida', text: data.message });
        }
    }

    // Compatibilidad con onclick antiguo
    async function enviarLista(code) {
        await verDesdeCola(code);
    }
</script>
{% endblock %}
