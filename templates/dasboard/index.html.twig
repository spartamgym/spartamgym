{% extends 'base.html.twig' %}

{% block title %}Hello DasboardController!
{% endblock %}

{% block body %}
	<main id="main" class="container-fluid">

		<div class="row m-0 py-4">
			<div class="col-12">
				<h1>Bienvenido apreciado cliente</h1>
			</div>
		</div>
		<!-- End Page Title -->

		<section class="section profile">
			<div class="row mb-2">
				<div class="col-xl-4">
					<div class="card">
						<div class="card-body profile-card pt-4 d-flex flex-column align-items-center">
							<img id="img-perfil" src="img/profile-img.jpeg" alt="Profile" class="rounded-circle img-fluid" style="width: 150px; aspect-ratio: 1 / 1; object-fit: cover;">
							<h2 id="nombre-perfil"></h2>
						</div>
					</div>
					<!-- Plantilla Plan -->

					<div class="card shadow-sm">
						<div class="card-body text-center">
							
							<h5 class="card-title" id="titulo"></h5>
							<h3 class="my-3">
								<span id="precio"></span>
								<small class="text-muted" id="periodo"></small>
							</h3>
							<ul class="list-group list-group-flush text-start" id="beneficios"></ul>

						</div>
					</div>

				</div>

				<div class="col-xl-8">

					<div class="card">
						<div
							class="card-body pt-3">
							<!-- Bordered Tabs -->
							<ul class="nav nav-tabs nav-tabs-bordered">

								<li class="nav-item">
									<button class="nav-link active" data-bs-toggle="tab" data-bs-target="#profile-overview">Datos Personales</button>
								</li>

								<li class="nav-item">
									<button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-edit">Datos Fisicos</button>
								</li>

								<li class="nav-item">
									<button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-settings">Plan</button>
								</li>


							</ul>
							<div class="tab-content pt-2">


								<div class="tab-pane fade show active profile-overview" id="profile-overview">
									<div class="row">
										<div class="col-lg-3 col-md-4 label">Nombre</div>
										<div class="col-lg-9 col-md-8" id="nombre"></div>
									</div>

									<div class="row">
										<div class="col-lg-3 col-md-4 label">WhatsApp</div>
										<div class="col-lg-9 col-md-8" id="celular"></div>
									</div>

									<div class="row">
										<div class="col-lg-3 col-md-4 label">Cedula</div>
										<div class="col-lg-9 col-md-8" id="cedula"></div>
									</div>

									<div class="row">
										<div class="col-lg-3 col-md-4 label">Direccion</div>
										<div class="col-lg-9 col-md-8" id="direccion"></div>
									</div>

									<div class="row">
										<div class="col-lg-3 col-md-4 label">Cumplea침os</div>
										<div class="col-lg-9 col-md-8" id="fecha_nacimiento"></div>
									</div>

									<div class="row">
										<div class="col-lg-3 col-md-4 label">EPS</div>
										<div class="col-lg-9 col-md-8" id="eps"></div>
									</div>

									<div class="row">
										<div class="col-lg-3 col-md-4 label">Email</div>
										<div class="col-lg-9 col-md-8" id="correo"></div>
									</div>
								</div>

								<div class="tab-pane fade profile-edit pt-3" id="profile-edit">
									<table class="table table-sm" id="table_menu" data-toggle="table">
										<thead>
											<tr>
												<th colspan="9" class="text-center bg-dark text-white">Datos</th>
											</tr>
											<tr>
												<th data-field="id">ID</th>
												<th data-field="peso">Peso(Kg)</th>
												<th data-field="cintura">Cintura(cm)</th>
												<th data-field="gluteos">Gl칰teos(cm)</th>
												<th data-field="brazo">Braz(cm)</th>
												<th data-field="pecho">Pecho(cm)</th>
												<th data-field="pierna">Pierna(cm)</th>
												<th data-field="pantorrilla">Pantorrilla(cm)</th>
												<th data-field="createAt">Creado</th>
											</tr>
										</thead>
									</table>

								</div>

								<div class="tab-pane fade pt-3" id="profile-settings">
									<table class="table table-sm" id="table_planes" data-toggle="table">
										<thead>
											<tr>
												<th colspan="5" class="text-center bg-dark text-white">Planes</th>
											</tr>
											<tr>
												<th data-field="nombre">Plan</th>
												<th data-field="precio">Precio</th>
												<th data-field="tiempo">Periodo</th>
												<th data-field="detalle">Beneficios</th>
											<th data-field="isActive" data-formatter="activoFormatter">Activo</th>

											</tr>
										</thead>
									</table>

								</div>


							</div>
							<!-- End Bordered Tabs -->

						</div>
					</div>

				</div>
			</div>
		</section>

	</main>
	<!-- End #main -->
	<script>
		const imgPerfil = document.getElementById('img-perfil');
const nombrePerfil = document.getElementById('nombre-perfil');


// Configura la conexi칩n SSE
const eventSource = new EventSource('/sse');

eventSource.onopen = () => {
console.log('Conexi칩n SSE abierta');
};

eventSource.onmessage = (event) => {
try {
const userData = JSON.parse(event.data);
imgPerfil.src = userData.img;
nombrePerfil.textContent = userData.nombre;
document.getElementById('nombre').textContent = userData.nombre;
document.getElementById('celular').textContent = userData.celular;
document.getElementById('cedula').textContent = userData.cedula;
document.getElementById('direccion').textContent = userData.direccion;
document.getElementById('fecha_nacimiento').textContent = userData.fecha_nacimiento;
document.getElementById('eps').textContent = userData.eps;
document.getElementById('correo').textContent = userData.correo;
$('#table_menu').bootstrapTable('load', userData.datofisicos);

const planes = userData.planes.map(item => ({
  ...item.plan,
  isActive: item.isActive,
  detalle: item.plan.detalle.join(", ")
}));
console.log(userData.planes);
// Inicializar tabla con Bootstrap Table
$('#table_planes').bootstrapTable('load', planes);
const plan = userData.planes.find(p => p.isActive).plan;	

//$('#table_planes').bootstrapTable('load', userData.planes);

console.log('Datos recibidos:', userData);
// 游댢 Rellenar plantilla
document.getElementById("titulo").textContent = plan.nombre;
document.getElementById("precio").textContent = "$"+plan.precio.toFixed(2) + " COP";
document.getElementById("periodo").textContent = plan.periodo;

const lista = document.getElementById("beneficios");
plan.detalle.forEach(b => {
const li = document.createElement("li");
li.className = "list-group-item";
li.innerHTML = "<i class ='bi bi-check-circle text-success'></i> " + b;
lista.appendChild(li);
});
} catch (e) {
console.warn('Error al parsear datos SSE:', e);
}
};

eventSource.onerror = (error) => {
console.error('Error SSE:', error.message);
// El navegador intentar치 reconectar autom치ticamente
};


function activoFormatter(value, row, index) {
  if (value) {
    return '<span class="text-success"><i class="bi bi-check-circle-fill"></i> S칤</span>';
  } else {
    return '<span class="text-danger"><i class="bi bi-x-circle-fill"></i> No</span>';
  }
}


	</script>

{% endblock %}
